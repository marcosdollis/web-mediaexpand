<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width={{ conteudo.design_largura }}, height={{ conteudo.design_altura }}, initial-scale=1.0, user-scalable=no">
<title>MediaExpand TV â€” Design: {{ conteudo.titulo }}</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
    width: {{ conteudo.design_largura }}px;
    height: {{ conteudo.design_altura }}px;
    overflow: hidden;
    background: #000;
}
canvas { display: block; position: absolute; top: 0; left: 0; }
</style>
</head>
<body>
<canvas id="canvasA" width="{{ conteudo.design_largura }}" height="{{ conteudo.design_altura }}"></canvas>
<canvas id="canvasB" width="{{ conteudo.design_largura }}" height="{{ conteudo.design_altura }}"></canvas>
<audio id="pageAudio" preload="auto"></audio>

<script>
(function() {
    'use strict';
    var designData = {{ design_json|safe }};
    var CW = {{ conteudo.design_largura }};
    var CH = {{ conteudo.design_altura }};

    // Normalize: support both old single-canvas JSON and new multi-page format
    var pages;
    if (designData && designData._version === 2 && designData.pages) {
        pages = designData.pages;
    } else if (designData) {
        pages = [{
            id: 'page_1', name: 'Slide 1',
            duration: {{ conteudo.duracao_segundos|default:15 }},
            transition: 'fade', transitionDuration: 0.5,
            audioUrl: '', fabricJson: designData, animations: []
        }];
    } else {
        pages = [];
    }
    if (pages.length === 0) return;

    var staticA = new fabric.StaticCanvas('canvasA', { width: CW, height: CH });
    var staticB = new fabric.StaticCanvas('canvasB', { width: CW, height: CH });
    var elA = document.getElementById('canvasA');
    var elB = document.getElementById('canvasB');
    var audioEl = document.getElementById('pageAudio');
    var currentPageIdx = 0;
    var activeCanvas = 'A';

    function loadPage(pageIdx, cb) {
        var page = pages[pageIdx];
        if (!page || !page.fabricJson) { if (cb) cb(); return; }
        var target = (activeCanvas === 'A') ? staticB : staticA;
        var json = JSON.parse(JSON.stringify(page.fabricJson));
        delete json.width; delete json.height;
        target.loadFromJSON(json, function() {
            target.setWidth(CW); target.setHeight(CH);
            target.renderAll();
            if (cb) cb();
        });
    }

    function transitionTo(pageIdx) {
        var page = pages[pageIdx];
        var dur = (page.transitionDuration || 0.5);
        var showEl = (activeCanvas === 'A') ? elB : elA;
        var hideEl = (activeCanvas === 'A') ? elA : elB;

        if (page.transition === 'none') {
            showEl.style.transition = 'none';
            hideEl.style.transition = 'none';
        } else {
            showEl.style.transition = 'opacity ' + dur + 's ease';
            hideEl.style.transition = 'opacity ' + dur + 's ease';
        }
        showEl.style.opacity = '1';
        hideEl.style.opacity = '0';
        activeCanvas = (activeCanvas === 'A') ? 'B' : 'A';

        if (page.audioUrl) {
            audioEl.src = page.audioUrl;
            audioEl.play().catch(function() {});
        } else { audioEl.pause(); audioEl.src = ''; }

        if (page.animations && page.animations.length > 0) runAnimations(pageIdx);
    }

    function runAnimations(pageIdx) {
        var page = pages[pageIdx];
        var cvs = (activeCanvas === 'A') ? staticA : staticB;
        var objects = cvs.getObjects();
        page.animations.forEach(function(anim) {
            var obj = objects[anim.objectIndex];
            if (!obj) return;
            var delay = (anim.delay || 0) * 1000;
            var dur = (anim.duration || 1) * 1000;
            setTimeout(function() {
                switch (anim.type) {
                    case 'fadeIn':
                        obj.set('opacity', 0); cvs.renderAll();
                        animProp(cvs, obj, 'opacity', 0, 1, dur); break;
                    case 'slideLeft':
                        var oL = obj.left; obj.set({left: CW, opacity: 1}); cvs.renderAll();
                        animProp(cvs, obj, 'left', CW, oL, dur); break;
                    case 'slideRight':
                        var oL2 = obj.left; obj.set({left: -obj.getScaledWidth(), opacity: 1}); cvs.renderAll();
                        animProp(cvs, obj, 'left', -obj.getScaledWidth(), oL2, dur); break;
                    case 'slideUp':
                        var oT = obj.top; obj.set({top: CH, opacity: 1}); cvs.renderAll();
                        animProp(cvs, obj, 'top', CH, oT, dur); break;
                    case 'slideDown':
                        var oT2 = obj.top; obj.set({top: -obj.getScaledHeight(), opacity: 1}); cvs.renderAll();
                        animProp(cvs, obj, 'top', -obj.getScaledHeight(), oT2, dur); break;
                    case 'zoomIn':
                        var sx = obj.scaleX, sy = obj.scaleY;
                        obj.set({scaleX:0, scaleY:0, opacity:1}); cvs.renderAll();
                        animProp(cvs, obj, 'scaleX', 0, sx, dur);
                        animProp(cvs, obj, 'scaleY', 0, sy, dur); break;
                    case 'bounceIn':
                        obj.set('opacity', 0); cvs.renderAll();
                        animProp(cvs, obj, 'opacity', 0, 1, dur, true); break;
                }
            }, delay);
        });
    }

    function animProp(cvs, obj, prop, from, to, dur, bounce) {
        var start = performance.now();
        function step(now) {
            var t = Math.min((now - start) / dur, 1);
            var e = bounce ? easeOutBounce(t) : easeInOutQuad(t);
            obj.set(prop, from + (to - from) * e);
            cvs.renderAll();
            if (t < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
    }
    function easeInOutQuad(t) { return t < 0.5 ? 2*t*t : -1+(4-2*t)*t; }
    function easeOutBounce(t) {
        if (t < 1/2.75) return 7.5625*t*t;
        if (t < 2/2.75) { t -= 1.5/2.75; return 7.5625*t*t + 0.75; }
        if (t < 2.5/2.75) { t -= 2.25/2.75; return 7.5625*t*t + 0.9375; }
        t -= 2.625/2.75; return 7.5625*t*t + 0.984375;
    }

    // Load first page
    var fp = pages[0];
    var fj = fp.fabricJson ? JSON.parse(JSON.stringify(fp.fabricJson)) : {};
    delete fj.width; delete fj.height;
    staticA.loadFromJSON(fj, function() {
        staticA.setWidth(CW); staticA.setHeight(CH);
        staticA.renderAll();
        elA.style.opacity = '1'; elB.style.opacity = '0';
        if (fp.audioUrl) { audioEl.src = fp.audioUrl; audioEl.play().catch(function(){}); }
        if (fp.animations && fp.animations.length > 0) runAnimations(0);
        if (pages.length > 1) scheduleNext();
    });

    function scheduleNext() {
        var dur = (pages[currentPageIdx].duration || 5) * 1000;
        setTimeout(function() {
            var next = (currentPageIdx + 1) % pages.length;
            loadPage(next, function() {
                transitionTo(next);
                currentPageIdx = next;
                scheduleNext();
            });
        }, dur);
    }
})();
</script>
</body>
</html>
