{% extends "base/base.html" %}
{% load static %}

{% block title %}{% if conteudo %}Editar Design{% else %}Novo Design{% endif %} - MediaExpand{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ═══════════════════ DESIGN EDITOR LAYOUT ═══════════════════ */
:root {
    --editor-sidebar: 300px;
    --editor-toolbar: 50px;
    --editor-header: 56px;
    --brand-primary: #667eea;
    --brand-secondary: #764ba2;
    --panel-bg: #1e1e2e;
    --panel-surface: #2a2a3e;
    --panel-border: #3a3a4e;
    --panel-text: #e0e0e0;
    --panel-text-muted: #8888aa;
    --accent: #667eea;
}

.design-editor-wrapper {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    flex-direction: column;
    z-index: 9999;
    background: var(--panel-bg);
    font-family: 'Inter', sans-serif;
}

/* ── TOP BAR ── */
.editor-topbar {
    height: var(--editor-header);
    background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
    display: flex;
    align-items: center;
    padding: 0 16px;
    gap: 12px;
    flex-shrink: 0;
    z-index: 10;
}
.editor-topbar .brand {
    color: #fff;
    font-weight: 700;
    font-size: 16px;
    white-space: nowrap;
}
.editor-topbar .btn-back {
    color: rgba(255,255,255,0.8);
    text-decoration: none;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 4px;
}
.editor-topbar .btn-back:hover { color: #fff; }
.editor-topbar input.title-input {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 6px;
    color: #fff;
    padding: 6px 12px;
    font-size: 14px;
    width: 260px;
}
.editor-topbar input.title-input::placeholder { color: rgba(255,255,255,0.5); }
.editor-topbar input.title-input:focus { outline: none; background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.4); }
.editor-topbar .topbar-actions { margin-left: auto; display: flex; gap: 8px; align-items: center; }
.editor-topbar .btn-editor {
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
}
.btn-editor-outline {
    background: rgba(255,255,255,0.15);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.3) !important;
}
.btn-editor-outline:hover { background: rgba(255,255,255,0.25); }
.btn-editor-save {
    background: #28a745;
    color: #fff;
}
.btn-editor-save:hover { background: #218838; }

/* ── MAIN AREA ── */
.editor-main {
    flex: 1;
    display: flex;
    overflow: hidden;
}

/* ── LEFT PANEL (Tools) ── */
.editor-left-panel {
    width: var(--editor-sidebar);
    background: var(--panel-bg);
    border-right: 1px solid var(--panel-border);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    overflow-x: hidden;
    flex-shrink: 0;
}
.panel-section {
    padding: 12px;
    border-bottom: 1px solid var(--panel-border);
}
.panel-section-title {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--panel-text-muted);
    margin-bottom: 10px;
}
.tool-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
}
.tool-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 10px 4px;
    border-radius: 8px;
    background: var(--panel-surface);
    border: 1px solid transparent;
    color: var(--panel-text);
    cursor: pointer;
    font-size: 11px;
    gap: 4px;
    transition: all 0.15s;
}
.tool-btn i { font-size: 18px; }
.tool-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
.tool-btn.active { background: var(--accent); color: #fff; }

/* Color palette */
.color-palette {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}
.color-swatch {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.15s;
}
.color-swatch:hover { transform: scale(1.15); }
.color-swatch.active { border-color: #fff; box-shadow: 0 0 0 2px var(--accent); }

/* Font selector */
.font-selector select,
.font-selector input {
    background: var(--panel-surface);
    border: 1px solid var(--panel-border);
    color: var(--panel-text);
    border-radius: 6px;
    padding: 6px 8px;
    font-size: 12px;
    width: 100%;
}
.font-selector select:focus,
.font-selector input:focus {
    outline: none;
    border-color: var(--accent);
}

/* ── CANVAS AREA ── */
.editor-canvas-area {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #13131f;
    overflow: auto;
    position: relative;
}
.canvas-container-wrapper {
    position: relative;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    border-radius: 4px;
    /* NO overflow:hidden and NO CSS transform — zoom is handled by Fabric's setZoom() */
}
.canvas-container-wrapper .canvas-container {
    display: block !important;
}

/* Zoom bar */
.zoom-bar {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--panel-surface);
    border: 1px solid var(--panel-border);
    border-radius: 20px;
    padding: 6px 14px;
}
.zoom-bar button {
    background: none;
    border: none;
    color: var(--panel-text);
    cursor: pointer;
    font-size: 14px;
    padding: 2px 4px;
}
.zoom-bar button:hover { color: var(--accent); }
.zoom-bar span { font-size: 12px; color: var(--panel-text-muted); min-width: 40px; text-align: center; }

/* ── RIGHT PANEL (Properties) ── */
.editor-right-panel {
    width: var(--editor-sidebar);
    background: var(--panel-bg);
    border-left: 1px solid var(--panel-border);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    flex-shrink: 0;
}
.prop-group { padding: 12px; border-bottom: 1px solid var(--panel-border); }
.prop-group label {
    display: block;
    font-size: 11px;
    font-weight: 500;
    color: var(--panel-text-muted);
    margin-bottom: 4px;
}
.prop-group input[type="text"],
.prop-group input[type="number"],
.prop-group input[type="color"],
.prop-group select,
.prop-group textarea {
    width: 100%;
    background: var(--panel-surface);
    border: 1px solid var(--panel-border);
    color: var(--panel-text);
    border-radius: 6px;
    padding: 6px 8px;
    font-size: 12px;
}
.prop-group input:focus,
.prop-group select:focus,
.prop-group textarea:focus {
    outline: none;
    border-color: var(--accent);
}
.prop-row {
    display: flex;
    gap: 8px;
}
.prop-row > div { flex: 1; }

/* Layers */
.layer-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    color: var(--panel-text);
    transition: background 0.15s;
}
.layer-item:hover { background: var(--panel-surface); }
.layer-item.selected { background: var(--accent); color: #fff; }
.layer-item .layer-icon { width: 20px; text-align: center; }
.layer-item .layer-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.layer-item .layer-actions { display: flex; gap: 2px; }
.layer-item .layer-actions button {
    background: none; border: none; color: inherit; cursor: pointer; font-size: 11px; padding: 2px;
    opacity: 0.6;
}
.layer-item .layer-actions button:hover { opacity: 1; }

/* ── RESPONSIVE (hide panels on small screens) ── */
@media (max-width: 992px) {
    .editor-left-panel, .editor-right-panel { width: 250px; }
}
@media (max-width: 768px) {
    .editor-right-panel { display: none; }
    .editor-left-panel { width: 60px; }
    .tool-btn span { display: none; }
    .panel-section-title { display: none; }
}

/* Template picker modal */
.template-modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    z-index: 10000;
    align-items: center;
    justify-content: center;
}
.template-modal-overlay.show { display: flex; }
.template-modal {
    background: var(--panel-bg);
    border: 1px solid var(--panel-border);
    border-radius: 12px;
    width: 90%;
    max-width: 900px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 24px;
}
.template-modal h3 { color: #fff; margin-bottom: 16px; }
.template-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 16px;
}
.template-card {
    background: var(--panel-surface);
    border-radius: 10px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s;
}
.template-card:hover { border-color: var(--accent); transform: translateY(-2px); }
.template-card img {
    width: 100%;
    aspect-ratio: 16/9;
    object-fit: cover;
    background: #333;
}
.template-card .template-info {
    padding: 10px;
}
.template-card .template-info h6 { color: #fff; margin: 0; font-size: 13px; }
.template-card .template-info small { color: var(--panel-text-muted); }

/* Scrollbar */
.editor-left-panel::-webkit-scrollbar,
.editor-right-panel::-webkit-scrollbar,
.template-modal::-webkit-scrollbar { width: 6px; }
.editor-left-panel::-webkit-scrollbar-track,
.editor-right-panel::-webkit-scrollbar-track { background: transparent; }
.editor-left-panel::-webkit-scrollbar-thumb,
.editor-right-panel::-webkit-scrollbar-thumb { background: var(--panel-border); border-radius: 3px; }

/* Image upload area */
.image-upload-zone {
    border: 2px dashed var(--panel-border);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    color: var(--panel-text-muted);
    transition: all 0.2s;
}
.image-upload-zone:hover {
    border-color: var(--accent);
    color: var(--accent);
}
.image-upload-zone i { font-size: 24px; display: block; margin-bottom: 6px; }

/* Settings modal */
.settings-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    background: var(--panel-bg);
    border: 1px solid var(--panel-border);
    border-radius: 8px;
    padding: 16px;
    min-width: 280px;
    z-index: 100;
    display: none;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
}
.settings-dropdown.show { display: block; }
.settings-dropdown label { color: var(--panel-text-muted); font-size: 12px; font-weight: 500; margin-bottom: 4px; display: block; }
.settings-dropdown input, .settings-dropdown select {
    width: 100%;
    background: var(--panel-surface);
    border: 1px solid var(--panel-border);
    color: var(--panel-text);
    border-radius: 6px;
    padding: 6px 8px;
    font-size: 12px;
    margin-bottom: 10px;
}

/* Save feedback */
.save-toast {
    position: fixed;
    top: 70px;
    right: 20px;
    background: #28a745;
    color: #fff;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    z-index: 10001;
    display: none;
    box-shadow: 0 4px 12px rgba(40,167,69,0.4);
}
.save-toast.error { background: #dc3545; box-shadow: 0 4px 12px rgba(220,53,69,0.4); }
.save-toast.show { display: block; animation: slideIn 0.3s ease; }
@keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

/* ── PAGE STRIP (FILMSTRIP) ── */
.page-strip-container {
    height: 120px;
    background: var(--panel-bg);
    border-top: 1px solid var(--panel-border);
    display: flex;
    align-items: center;
    padding: 0 12px;
    gap: 8px;
    flex-shrink: 0;
    overflow-x: auto;
}
.page-strip-container::-webkit-scrollbar { height: 4px; }
.page-strip-container::-webkit-scrollbar-thumb { background: var(--panel-border); border-radius: 2px; }
.page-thumb {
    min-width: 140px; max-width: 140px; height: 90px;
    border-radius: 8px; border: 2px solid var(--panel-border);
    background: var(--panel-surface); cursor: pointer;
    position: relative; overflow: hidden; flex-shrink: 0;
    transition: border-color 0.2s;
}
.page-thumb:hover { border-color: var(--accent); }
.page-thumb.active { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(102,126,234,0.3); }
.page-thumb img { width: 100%; height: 100%; object-fit: contain; display: block; }
.page-thumb-label {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: rgba(0,0,0,0.7); color: #fff; font-size: 10px;
    text-align: center; padding: 2px 4px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.page-thumb-duration {
    position: absolute; top: 4px; right: 4px;
    background: rgba(0,0,0,0.6); color: #fff; font-size: 9px;
    padding: 1px 4px; border-radius: 3px;
}
.page-thumb-delete {
    position: absolute; top: 4px; left: 4px;
    background: rgba(220,53,69,0.8); color: #fff; border: none;
    border-radius: 50%; width: 18px; height: 18px; font-size: 10px;
    cursor: pointer; display: none; align-items: center;
    justify-content: center; line-height: 1;
}
.page-thumb:hover .page-thumb-delete { display: flex; }
.page-add-btn {
    min-width: 60px; height: 90px; border-radius: 8px;
    border: 2px dashed var(--panel-border); background: transparent;
    color: var(--panel-text-muted); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px; flex-shrink: 0; transition: all 0.2s;
}
.page-add-btn:hover { border-color: var(--accent); color: var(--accent); }

/* ── PAGE SETTINGS BAR ── */
.page-settings-bar {
    height: 36px; background: var(--panel-surface);
    border-top: 1px solid var(--panel-border);
    display: flex; align-items: center; padding: 0 12px;
    gap: 12px; flex-shrink: 0; font-size: 12px; color: var(--panel-text);
}
.page-settings-bar label { color: var(--panel-text-muted); font-size: 11px; margin-right: 4px; }
.page-settings-bar input, .page-settings-bar select {
    background: var(--panel-bg); border: 1px solid var(--panel-border);
    color: var(--panel-text); border-radius: 4px; padding: 2px 6px; font-size: 11px;
}
.page-settings-bar input[type="number"] { width: 60px; }
.page-settings-bar select { width: 120px; }

/* ── ANIMATION PANEL ── */
.anim-item {
    display: flex; align-items: center; gap: 6px;
    padding: 6px 8px; background: var(--panel-surface);
    border-radius: 6px; margin-bottom: 4px; font-size: 11px; color: var(--panel-text);
}
.anim-item select, .anim-item input {
    background: var(--panel-bg); border: 1px solid var(--panel-border);
    color: var(--panel-text); border-radius: 4px; padding: 2px 4px; font-size: 11px;
}
.anim-item select { width: 90px; }
.anim-item input { width: 50px; }
.anim-item button { background: none; border: none; color: #dc3545; cursor: pointer; font-size: 12px; }

/* ── AUDIO PANEL ── */
.audio-controls {
    display: flex; align-items: center; gap: 8px;
    padding: 8px; background: var(--panel-surface); border-radius: 6px;
}
.audio-controls button {
    background: var(--panel-bg); border: 1px solid var(--panel-border);
    color: var(--panel-text); border-radius: 4px; padding: 4px 8px;
    cursor: pointer; font-size: 11px;
}
.audio-controls button:hover { border-color: var(--accent); color: var(--accent); }
.audio-filename {
    font-size: 11px; color: var(--panel-text-muted);
    overflow: hidden; text-overflow: ellipsis;
    white-space: nowrap; max-width: 150px;
}

/* ── MEDIA LIBRARY PANEL ── */
.media-lib-tabs {
    display: flex; gap: 2px; margin-bottom: 8px;
    background: var(--panel-surface); border-radius: 6px; padding: 2px;
}
.media-lib-tab {
    flex: 1; text-align: center; padding: 6px 4px;
    font-size: 10px; font-weight: 600;
    color: var(--panel-text-muted); cursor: pointer;
    border-radius: 5px; border: none; background: transparent;
    transition: all 0.15s; white-space: nowrap;
}
.media-lib-tab:hover { color: var(--panel-text); }
.media-lib-tab.active { background: var(--accent); color: #fff; }
.media-lib-tab i { display: block; font-size: 14px; margin-bottom: 2px; }
.media-search-box {
    display: flex; gap: 4px; margin-bottom: 8px;
}
.media-search-box input {
    flex: 1; background: var(--panel-surface); border: 1px solid var(--panel-border);
    color: var(--panel-text); border-radius: 6px; padding: 6px 8px; font-size: 12px;
}
.media-search-box input:focus { outline: none; border-color: var(--accent); }
.media-search-box input::placeholder { color: var(--panel-text-muted); }
.media-search-box button {
    background: var(--accent); border: none; color: #fff; border-radius: 6px;
    padding: 6px 10px; cursor: pointer; font-size: 12px;
}
.media-search-box button:hover { opacity: 0.85; }
.media-results-grid {
    display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;
    max-height: 400px; overflow-y: auto; padding-right: 4px;
}
.media-results-grid::-webkit-scrollbar { width: 4px; }
.media-results-grid::-webkit-scrollbar-thumb { background: var(--panel-border); border-radius: 2px; }
.media-result-item {
    position: relative; border-radius: 6px; overflow: hidden;
    cursor: pointer; border: 2px solid transparent;
    transition: all 0.15s; background: var(--panel-surface);
    display: flex; align-items: center; justify-content: center;
    min-height: 120px; padding: 4px;
}
.media-result-item:hover { border-color: var(--accent); transform: scale(1.02); }
.media-result-item img {
    max-width: 100%; max-height: 150px; object-fit: contain; display: block;
    border-radius: 4px;
}
.media-result-item .media-item-overlay {
    position: absolute; bottom: 0; left: 0; right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    padding: 4px 6px; font-size: 9px; color: #fff;
    opacity: 0; transition: opacity 0.15s;
}
.media-result-item:hover .media-item-overlay { opacity: 1; }
.media-load-more {
    grid-column: 1 / -1; text-align: center; padding: 8px;
}
.media-load-more button {
    background: var(--panel-surface); border: 1px solid var(--panel-border);
    color: var(--panel-text); border-radius: 6px; padding: 6px 16px;
    cursor: pointer; font-size: 11px; width: 100%;
}
.media-load-more button:hover { border-color: var(--accent); color: var(--accent); }
.media-status {
    text-align: center; padding: 12px 8px; font-size: 11px;
    color: var(--panel-text-muted);
}
.media-status i { font-size: 20px; display: block; margin-bottom: 4px; }
/* Icon results (3 cols) */
.icon-results-grid {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px;
    max-height: 400px; overflow-y: auto; padding-right: 2px;
}
.icon-results-grid::-webkit-scrollbar { width: 4px; }
.icon-results-grid::-webkit-scrollbar-thumb { background: var(--panel-border); border-radius: 2px; }
.icon-result-item {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 8px 4px; border-radius: 6px; cursor: pointer;
    background: var(--panel-surface); border: 2px solid transparent;
    transition: all 0.15s; min-height: 64px;
}
.icon-result-item:hover { border-color: var(--accent); background: rgba(102,126,234,0.1); }
.icon-result-item img {
    width: 32px; height: 32px; filter: invert(0.9);
}
.icon-result-item span {
    font-size: 8px; color: var(--panel-text-muted); margin-top: 2px;
    text-align: center; overflow: hidden; text-overflow: ellipsis;
    white-space: nowrap; max-width: 100%;
}
/* Categories / quick filters */
.media-categories {
    display: flex; flex-wrap: wrap; gap: 3px; margin-bottom: 8px;
}
.media-cat-btn {
    font-size: 10px; padding: 3px 8px; border-radius: 12px;
    background: var(--panel-surface); border: 1px solid var(--panel-border);
    color: var(--panel-text-muted); cursor: pointer; transition: all 0.15s;
}
.media-cat-btn:hover, .media-cat-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
/* Animation preview */
.anim-preview-btn {
    background: var(--accent); border: none; color: #fff;
    border-radius: 4px; padding: 4px 8px; cursor: pointer;
    font-size: 11px; width: 100%; margin-top: 4px;
}
.anim-preview-btn:hover { opacity: 0.85; }
</style>
{% endblock %}

{% block content %}
<!-- The editor is fullscreen, so we override the content block to escape the container -->
{% endblock %}

{% block extra_js %}
<!-- Fabric.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

<!-- Save Toast -->
<div id="saveToast" class="save-toast"></div>

<!-- Main Editor (fullscreen overlay) -->
<div class="design-editor-wrapper" id="editorWrapper">
    <!-- ── TOP BAR ── -->
    <div class="editor-topbar">
        <a href="{% url 'design_list' %}" class="btn-back">
            <i class="fas fa-arrow-left"></i>
        </a>
        <span class="brand"><i class="fas fa-palette me-1"></i>Design Editor</span>
        <input type="text" class="title-input" id="designTitle"
               placeholder="Nome do design..."
               value="{{ conteudo.titulo|default:'' }}">
        <div class="topbar-actions">
            <button class="btn-editor btn-editor-outline" onclick="undoAction()" title="Desfazer (Ctrl+Z)">
                <i class="fas fa-undo"></i>
            </button>
            <button class="btn-editor btn-editor-outline" onclick="redoAction()" title="Refazer (Ctrl+Y)">
                <i class="fas fa-redo"></i>
            </button>
            <div style="width:1px;height:24px;background:rgba(255,255,255,0.2);"></div>
            <div style="position:relative;">
                <button class="btn-editor btn-editor-outline" onclick="toggleSettings()" title="Configurações">
                    <i class="fas fa-cog"></i>
                </button>
                <div class="settings-dropdown" id="settingsDropdown">
                    <label>Largura (px)</label>
                    <input type="number" id="canvasWidth" value="{{ conteudo.design_largura|default:1920 }}" min="100">
                    <label>Altura (px)</label>
                    <input type="number" id="canvasHeight" value="{{ conteudo.design_altura|default:1080 }}" min="100">
                    <label>Duração na TV (s)</label>
                    <input type="number" id="designDuration" value="{{ conteudo.duracao_segundos|default:15 }}" min="3" max="300">
                    <label>Salvar como template</label>
                    <select id="isTemplate">
                        <option value="0" {% if not conteudo.is_template %}selected{% endif %}>Não</option>
                        <option value="1" {% if conteudo.is_template %}selected{% endif %}>Sim</option>
                    </select>
                    <label>Categoria do Template</label>
                    <input type="text" id="templateCategoria" value="{{ conteudo.template_categoria|default:'' }}"
                           placeholder="Ex: Promoção, Menu, Institucional">
                    <button class="btn-editor btn-editor-outline" style="width:100%; margin-top:4px;"
                            onclick="applyCanvasSize()">
                        <i class="fas fa-check me-1"></i>Aplicar Dimensões
                    </button>
                </div>
            </div>
            <div style="width:1px;height:24px;background:rgba(255,255,255,0.2);"></div>
            <button class="btn-editor btn-editor-outline" onclick="document.getElementById('pptxUpload').click()" title="Importar PPTX">
                <i class="fas fa-file-powerpoint me-1"></i>PPTX
            </button>
            <button class="btn-editor btn-editor-outline" onclick="previewDesign()" title="Preview">
                <i class="fas fa-eye me-1"></i>Preview
            </button>
            <button class="btn-editor btn-editor-save" onclick="saveDesign()" id="btnSave">
                <i class="fas fa-save me-1"></i>Salvar
            </button>
            <span id="saveIndicator" style="font-size:11px; margin-left:8px; white-space:nowrap;"></span>
        </div>
    </div>

    <!-- ── MAIN AREA ── -->
    <div class="editor-main">
        <!-- LEFT PANEL -->
        <div class="editor-left-panel" id="leftPanel">
            <!-- Insert Elements -->
            <div class="panel-section">
                <div class="panel-section-title">Inserir Elementos</div>
                <div class="tool-grid">
                    <button class="tool-btn" onclick="addText()" title="Texto">
                        <i class="fas fa-font"></i>
                        <span>Texto</span>
                    </button>
                    <button class="tool-btn" onclick="addHeading()" title="Título">
                        <i class="fas fa-heading"></i>
                        <span>Título</span>
                    </button>
                    <button class="tool-btn" onclick="addSubtext()" title="Subtítulo">
                        <i class="fas fa-text-height"></i>
                        <span>Sub</span>
                    </button>
                    <button class="tool-btn" onclick="addRect()" title="Retângulo">
                        <i class="far fa-square"></i>
                        <span>Retâng.</span>
                    </button>
                    <button class="tool-btn" onclick="addCircle()" title="Círculo">
                        <i class="far fa-circle"></i>
                        <span>Círculo</span>
                    </button>
                    <button class="tool-btn" onclick="addTriangle()" title="Triângulo">
                        <i class="fas fa-play fa-rotate-270"></i>
                        <span>Triâng.</span>
                    </button>
                    <button class="tool-btn" onclick="addLine()" title="Linha">
                        <i class="fas fa-minus"></i>
                        <span>Linha</span>
                    </button>
                    <button class="tool-btn" onclick="addStar()" title="Estrela">
                        <i class="far fa-star"></i>
                        <span>Estrela</span>
                    </button>
                    <button class="tool-btn" onclick="triggerImageUpload()" title="Imagem">
                        <i class="fas fa-image"></i>
                        <span>Imagem</span>
                    </button>
                </div>
                <input type="file" id="imageUpload" accept="image/*" style="display:none;"
                       onchange="handleImageUpload(event)">
            </div>

            <!-- Quick Shapes / Icons -->
            <div class="panel-section">
                <div class="panel-section-title">Formas Rápidas</div>
                <div class="tool-grid">
                    <button class="tool-btn" onclick="addRoundedRect()" title="Retângulo Arredondado">
                        <i class="fas fa-square" style="border-radius:4px;"></i>
                        <span>Arred.</span>
                    </button>
                    <button class="tool-btn" onclick="addDiamond()" title="Losango">
                        <i class="fas fa-diamond"></i>
                        <span>Losang.</span>
                    </button>
                    <button class="tool-btn" onclick="addArrow()" title="Seta">
                        <i class="fas fa-arrow-right"></i>
                        <span>Seta</span>
                    </button>
                </div>
            </div>

            <!-- Colors -->
            <div class="panel-section">
                <div class="panel-section-title">Cores</div>
                <div class="color-palette" id="colorPalette">
                    <!-- Filled by JS -->
                </div>
                <div style="margin-top:8px;">
                    <label style="font-size:11px; color:var(--panel-text-muted); display:block; margin-bottom:4px;">Cor personalizada</label>
                    <div style="display:flex; gap:4px;">
                        <input type="color" id="customColor" value="#667eea" style="width:36px; height:30px; border:none; background:none; cursor:pointer;">
                        <button class="tool-btn" style="flex:1; flex-direction:row; padding:4px 8px;" onclick="applyCustomColor('fill')">
                            <i class="fas fa-fill-drip" style="font-size:12px;"></i>
                            <span>Preencher</span>
                        </button>
                    </div>
                    <div style="display:flex; gap:4px; margin-top:4px;">
                        <button class="tool-btn" style="flex:1; flex-direction:row; padding:4px 8px;" onclick="applyCustomColor('stroke')">
                            <i class="fas fa-border-style" style="font-size:12px;"></i>
                            <span>Contorno</span>
                        </button>
                        <button class="tool-btn" style="flex:1; flex-direction:row; padding:4px 8px;" onclick="setCanvasBgColor()">
                            <i class="fas fa-palette" style="font-size:12px;"></i>
                            <span>Fundo</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Background Section -->
            <div class="panel-section">
                <div class="panel-section-title">Fundo do Canvas</div>
                <div class="tool-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <button class="tool-btn" onclick="setBgGradient('linear-gradient(135deg, #667eea, #764ba2)')">
                        <div style="width:30px;height:20px;border-radius:4px;background:linear-gradient(135deg,#667eea,#764ba2);"></div>
                        <span>Roxo</span>
                    </button>
                    <button class="tool-btn" onclick="setBgGradient('linear-gradient(135deg, #f093fb, #f5576c)')">
                        <div style="width:30px;height:20px;border-radius:4px;background:linear-gradient(135deg,#f093fb,#f5576c);"></div>
                        <span>Rosa</span>
                    </button>
                    <button class="tool-btn" onclick="setBgGradient('linear-gradient(135deg, #4facfe, #00f2fe)')">
                        <div style="width:30px;height:20px;border-radius:4px;background:linear-gradient(135deg,#4facfe,#00f2fe);"></div>
                        <span>Azul</span>
                    </button>
                    <button class="tool-btn" onclick="setBgGradient('linear-gradient(135deg, #43e97b, #38f9d7)')">
                        <div style="width:30px;height:20px;border-radius:4px;background:linear-gradient(135deg,#43e97b,#38f9d7);"></div>
                        <span>Verde</span>
                    </button>
                    <button class="tool-btn" onclick="setBgGradient('linear-gradient(135deg, #fa709a, #fee140)')">
                        <div style="width:30px;height:20px;border-radius:4px;background:linear-gradient(135deg,#fa709a,#fee140);"></div>
                        <span>Sunset</span>
                    </button>
                    <button class="tool-btn" onclick="setBgGradient('linear-gradient(135deg, #1e3c72, #2a5298)')">
                        <div style="width:30px;height:20px;border-radius:4px;background:linear-gradient(135deg,#1e3c72,#2a5298);"></div>
                        <span>Escuro</span>
                    </button>
                </div>
                <div style="margin-top:8px;">
                    <button class="tool-btn" style="width:100%; flex-direction:row; padding:6px;" onclick="triggerBgImageUpload()">
                        <i class="fas fa-image" style="font-size:12px;"></i>
                        <span>Imagem de Fundo</span>
                    </button>
                    <input type="file" id="bgImageUpload" accept="image/*" style="display:none;"
                           onchange="handleBgImageUpload(event)">
                </div>
            </div>

            <!-- ═══ MEDIA LIBRARY ═══ -->
            <div class="panel-section" id="mediaLibraryPanel">
                <div class="panel-section-title">Banco de Mídia</div>
                <!-- Tabs -->
                <div class="media-lib-tabs">
                    <button class="media-lib-tab active" onclick="switchMediaTab('photos')" id="tabPhotos">
                        <i class="fas fa-camera"></i>Fotos
                    </button>
                    <button class="media-lib-tab" onclick="switchMediaTab('illustrations')" id="tabIllust">
                        <i class="fas fa-paint-brush"></i>Ilustr.
                    </button>
                    <button class="media-lib-tab" onclick="switchMediaTab('icons')" id="tabIcons">
                        <i class="fas fa-icons"></i>Ícones
                    </button>
                    <button class="media-lib-tab" onclick="switchMediaTab('stickers')" id="tabStickers">
                        <i class="fas fa-shapes"></i>PNGs
                    </button>
                </div>
                <!-- Search -->
                <div class="media-search-box">
                    <input type="text" id="mediaSearchInput" placeholder="Buscar imagens..."
                           onkeydown="if(event.key==='Enter')searchMedia()">
                    <button onclick="searchMedia()" title="Buscar"><i class="fas fa-search"></i></button>
                </div>
                <!-- Quick categories (photos/illustrations) -->
                <div class="media-categories" id="mediaCategoriesBar">
                    <button class="media-cat-btn" onclick="searchMediaCategory('natureza')">Natureza</button>
                    <button class="media-cat-btn" onclick="searchMediaCategory('negócios')">Negócios</button>
                    <button class="media-cat-btn" onclick="searchMediaCategory('tecnologia')">Tech</button>
                    <button class="media-cat-btn" onclick="searchMediaCategory('comida')">Comida</button>
                    <button class="media-cat-btn" onclick="searchMediaCategory('pessoas')">Pessoas</button>
                    <button class="media-cat-btn" onclick="searchMediaCategory('cidade')">Cidade</button>
                    <button class="media-cat-btn" onclick="searchMediaCategory('abstrato')">Abstrato</button>
                    <button class="media-cat-btn" onclick="searchMediaCategory('saúde')">Saúde</button>
                </div>
                <!-- Results container -->
                <div id="mediaResultsContainer">
                    <div class="media-status" id="mediaStatusMsg">
                        <i class="fas fa-image"></i>
                        Busque fotos, ilustrações, ícones e PNGs gratuitos
                    </div>
                </div>
            </div>
        </div>

        <!-- CANVAS AREA -->
        <div class="editor-canvas-area" id="canvasArea">
            <div class="canvas-container-wrapper" id="canvasWrapper">
                <canvas id="designCanvas"></canvas>
            </div>

            <!-- Zoom controls -->
            <div class="zoom-bar">
                <button onclick="zoomOut()" title="Menos zoom"><i class="fas fa-search-minus"></i></button>
                <span id="zoomLevel">100%</span>
                <button onclick="zoomIn()" title="Mais zoom"><i class="fas fa-search-plus"></i></button>
                <button onclick="zoomFit()" title="Ajustar ao editor"><i class="fas fa-expand"></i></button>
            </div>
        </div>

        <!-- RIGHT PANEL (Properties & Layers) -->
        <div class="editor-right-panel" id="rightPanel">
            <!-- Object Properties -->
            <div class="prop-group" id="propsPanel" style="display:none;">
                <div class="panel-section-title">Propriedades do Objeto</div>
                <div class="prop-row" style="margin-bottom:8px;">
                    <div>
                        <label>X</label>
                        <input type="number" id="propX" onchange="updateObjProp('left', this.value)">
                    </div>
                    <div>
                        <label>Y</label>
                        <input type="number" id="propY" onchange="updateObjProp('top', this.value)">
                    </div>
                </div>
                <div class="prop-row" style="margin-bottom:8px;">
                    <div>
                        <label>Largura</label>
                        <input type="number" id="propW" onchange="updateObjScale('width', this.value)">
                    </div>
                    <div>
                        <label>Altura</label>
                        <input type="number" id="propH" onchange="updateObjScale('height', this.value)">
                    </div>
                </div>
                <div class="prop-row" style="margin-bottom:8px;">
                    <div>
                        <label>Rotação</label>
                        <input type="number" id="propAngle" onchange="updateObjProp('angle', this.value)">
                    </div>
                    <div>
                        <label>Opacidade</label>
                        <input type="number" id="propOpacity" min="0" max="100" step="5"
                               onchange="updateObjProp('opacity', this.value / 100)">
                    </div>
                </div>
            </div>

            <!-- Text Properties -->
            <div class="prop-group" id="textPropsPanel" style="display:none;">
                <div class="panel-section-title">Propriedades do Texto</div>
                <div style="margin-bottom:8px;">
                    <label>Fonte</label>
                    <select id="propFont" onchange="updateTextProp('fontFamily', this.value)">
                        <option value="Inter">Inter</option>
                        <option value="Arial">Arial</option>
                        <option value="Helvetica">Helvetica</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Impact">Impact</option>
                        <option value="Comic Sans MS">Comic Sans MS</option>
                        <option value="Trebuchet MS">Trebuchet MS</option>
                        <option value="Roboto">Roboto</option>
                        <option value="Open Sans">Open Sans</option>
                        <option value="Montserrat">Montserrat</option>
                        <option value="Poppins">Poppins</option>
                        <option value="Playfair Display">Playfair Display</option>
                        <option value="Oswald">Oswald</option>
                        <option value="Bebas Neue">Bebas Neue</option>
                    </select>
                </div>
                <div class="prop-row" style="margin-bottom:8px;">
                    <div>
                        <label>Tamanho</label>
                        <input type="number" id="propFontSize" min="8" max="400"
                               onchange="updateTextProp('fontSize', parseInt(this.value))">
                    </div>
                    <div>
                        <label>Peso</label>
                        <select id="propFontWeight" onchange="updateTextProp('fontWeight', this.value)">
                            <option value="300">Light</option>
                            <option value="normal">Normal</option>
                            <option value="500">Medium</option>
                            <option value="600">SemiBold</option>
                            <option value="bold">Bold</option>
                            <option value="800">Extra Bold</option>
                            <option value="900">Black</option>
                        </select>
                    </div>
                </div>
                <div style="display:flex; gap:4px; margin-bottom:8px;">
                    <button class="tool-btn" style="flex:1; flex-direction:row; padding:4px;" id="btnBold" onclick="toggleBold()">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button class="tool-btn" style="flex:1; flex-direction:row; padding:4px;" id="btnItalic" onclick="toggleItalic()">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button class="tool-btn" style="flex:1; flex-direction:row; padding:4px;" id="btnUnderline" onclick="toggleUnderline()">
                        <i class="fas fa-underline"></i>
                    </button>
                    <button class="tool-btn" style="flex:1; flex-direction:row; padding:4px;" id="btnStrikethrough" onclick="toggleStrikethrough()">
                        <i class="fas fa-strikethrough"></i>
                    </button>
                </div>
                <div style="display:flex; gap:4px; margin-bottom:8px;">
                    <button class="tool-btn" style="flex:1; flex-direction:row; padding:4px;" onclick="setTextAlign('left')">
                        <i class="fas fa-align-left"></i>
                    </button>
                    <button class="tool-btn" style="flex:1; flex-direction:row; padding:4px;" onclick="setTextAlign('center')">
                        <i class="fas fa-align-center"></i>
                    </button>
                    <button class="tool-btn" style="flex:1; flex-direction:row; padding:4px;" onclick="setTextAlign('right')">
                        <i class="fas fa-align-right"></i>
                    </button>
                </div>
                <div style="margin-bottom:8px;">
                    <label>Cor do Texto</label>
                    <input type="color" id="propTextColor" value="#ffffff"
                           onchange="updateTextProp('fill', this.value)">
                </div>
                <div style="margin-bottom:8px;">
                    <label>Espaçamento de Linhas</label>
                    <input type="number" id="propLineHeight" min="0.5" max="4" step="0.1"
                           onchange="updateTextProp('lineHeight', parseFloat(this.value))">
                </div>
            </div>

            <!-- Shape Properties -->
            <div class="prop-group" id="shapePropsPanel" style="display:none;">
                <div class="panel-section-title">Propriedades da Forma</div>
                <div style="margin-bottom:8px;">
                    <label>Cor de Preenchimento</label>
                    <input type="color" id="propFillColor" onchange="updateShapeProp('fill', this.value)">
                </div>
                <div style="margin-bottom:8px;">
                    <label>Cor do Contorno</label>
                    <input type="color" id="propStrokeColor" value="#000000"
                           onchange="updateShapeProp('stroke', this.value)">
                </div>
                <div style="margin-bottom:8px;">
                    <label>Espessura do Contorno</label>
                    <input type="number" id="propStrokeWidth" min="0" max="50" value="0"
                           onchange="updateShapeProp('strokeWidth', parseInt(this.value))">
                </div>
                <div style="margin-bottom:8px;">
                    <label>Arredondamento</label>
                    <input type="number" id="propBorderRadius" min="0" max="200" value="0"
                           onchange="updateShapeBorderRadius(this.value)">
                </div>
            </div>

            <!-- Alignment & Distribution -->
            <div class="prop-group" id="alignPanel" style="display:none;">
                <div class="panel-section-title">Alinhamento</div>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:4px;">
                    <button class="tool-btn" onclick="alignObject('left')" title="Esquerda">
                        <i class="fas fa-align-left"></i>
                    </button>
                    <button class="tool-btn" onclick="alignObject('centerH')" title="Centro H">
                        <i class="fas fa-arrows-alt-h"></i>
                    </button>
                    <button class="tool-btn" onclick="alignObject('right')" title="Direita">
                        <i class="fas fa-align-right"></i>
                    </button>
                    <button class="tool-btn" onclick="alignObject('top')" title="Topo">
                        <i class="fas fa-long-arrow-alt-up"></i>
                    </button>
                    <button class="tool-btn" onclick="alignObject('centerV')" title="Centro V">
                        <i class="fas fa-arrows-alt-v"></i>
                    </button>
                    <button class="tool-btn" onclick="alignObject('bottom')" title="Baixo">
                        <i class="fas fa-long-arrow-alt-down"></i>
                    </button>
                </div>
            </div>

            <!-- Object Actions -->
            <div class="prop-group" id="actionsPanel" style="display:none;">
                <div class="panel-section-title">Ações</div>
                <div style="display:grid; grid-template-columns: repeat(2, 1fr); gap:4px;">
                    <button class="tool-btn" onclick="bringForward()" title="Trazer pra frente">
                        <i class="fas fa-layer-group"></i>
                        <span>↑ Frente</span>
                    </button>
                    <button class="tool-btn" onclick="sendBackward()" title="Mandar pra trás">
                        <i class="fas fa-layer-group"></i>
                        <span>↓ Trás</span>
                    </button>
                    <button class="tool-btn" onclick="duplicateObject()" title="Duplicar">
                        <i class="fas fa-clone"></i>
                        <span>Duplicar</span>
                    </button>
                    <button class="tool-btn" onclick="deleteObject()" title="Deletar" style="border-color: #dc3545;">
                        <i class="fas fa-trash" style="color: #dc3545;"></i>
                        <span style="color: #dc3545;">Deletar</span>
                    </button>
                </div>
            </div>

            <!-- Animation Panel (per object) -->
            <div class="prop-group" id="animPanel" style="display:none;">
                <div class="panel-section-title">Animação do Objeto</div>
                <div id="animSettings">
                    <div style="margin-bottom:8px;">
                        <label>Tipo de Animação</label>
                        <select id="animType" onchange="updateSelectedObjectAnimation()">
                            <option value="none">Nenhuma</option>
                            <optgroup label="Entrada">
                                <option value="fadeIn">Fade In</option>
                                <option value="slideLeft">Deslizar da Esquerda</option>
                                <option value="slideRight">Deslizar da Direita</option>
                                <option value="slideUp">Deslizar de Baixo</option>
                                <option value="slideDown">Deslizar de Cima</option>
                                <option value="zoomIn">Zoom In</option>
                                <option value="zoomOut">Zoom Out</option>
                                <option value="bounceIn">Bounce In</option>
                                <option value="rotateIn">Rotação Entrada</option>
                                <option value="flipIn">Flip In</option>
                            </optgroup>
                            <optgroup label="Ênfase">
                                <option value="pulse">Pulsar</option>
                                <option value="shake">Tremer</option>
                                <option value="swing">Balançar</option>
                                <option value="rubberBand">Elástico</option>
                                <option value="float">Flutuar</option>
                                <option value="glow">Brilhar</option>
                            </optgroup>
                            <optgroup label="Contínua">
                                <option value="spinCW">Girar (Horário)</option>
                                <option value="spinCCW">Girar (Anti-Horário)</option>
                                <option value="breathe">Respirar</option>
                                <option value="blink">Piscar</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="prop-row" style="margin-bottom:8px;">
                        <div>
                            <label>Atraso (s)</label>
                            <input type="number" id="animDelay" value="0" min="0" max="10" step="0.1" onchange="updateSelectedObjectAnimation()">
                        </div>
                        <div>
                            <label>Duração (s)</label>
                            <input type="number" id="animDuration" value="1" min="0.1" max="5" step="0.1" onchange="updateSelectedObjectAnimation()">
                        </div>
                    </div>
                    <div style="margin-bottom:4px;">
                        <label>Easing</label>
                        <select id="animEasing" onchange="updateSelectedObjectAnimation()" style="width:100%; background:var(--panel-bg); border:1px solid var(--panel-border); color:var(--panel-text); border-radius:4px; padding:2px 4px; font-size:11px;">
                            <option value="easeInOut">Ease In Out</option>
                            <option value="easeIn">Ease In</option>
                            <option value="easeOut">Ease Out</option>
                            <option value="linear">Linear</option>
                            <option value="easeOutBounce">Bounce</option>
                            <option value="easeOutElastic">Elastic</option>
                            <option value="easeOutBack">Overshoot</option>
                        </select>
                    </div>
                    <button class="anim-preview-btn" onclick="previewAnimation()">
                        <i class="fas fa-play me-1"></i>Preview Animação
                    </button>
                </div>
            </div>

            <!-- Audio Panel (per page) -->
            <div class="prop-group" id="audioPanel">
                <div class="panel-section-title">Áudio da Página</div>
                <div class="audio-controls">
                    <button onclick="document.getElementById('audioUpload').click()" title="Upload áudio">
                        <i class="fas fa-upload me-1"></i>Upload
                    </button>
                    <span class="audio-filename" id="audioFilename">Sem áudio</span>
                    <button onclick="removePageAudio()" title="Remover áudio" style="margin-left:auto;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <audio id="audioPreview" controls style="width:100%; margin-top:6px; height:28px; display:none;"></audio>
            </div>

            <!-- Layers -->
            <div class="prop-group">
                <div class="panel-section-title">Camadas</div>
                <div id="layersList">
                    <div style="text-align:center; color:var(--panel-text-muted); font-size:12px; padding:12px;">
                        Nenhum elemento no canvas
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PAGE SETTINGS BAR -->
    <div class="page-settings-bar" id="pageSettingsBar">
        <label>Duração:</label>
        <input type="number" id="pageDuration" value="5" min="1" max="300" onchange="updateCurrentPageSetting('duration', parseFloat(this.value))"> <span>s</span>
        <div style="width:1px;height:20px;background:var(--panel-border);"></div>
        <label>Transição:</label>
        <select id="pageTransition" onchange="updateCurrentPageSetting('transition', this.value)">
            <option value="none">Nenhuma</option>
            <option value="fade" selected>Fade</option>
            <option value="slideLeft">Deslizar Esq.</option>
            <option value="slideRight">Deslizar Dir.</option>
            <option value="slideUp">Deslizar Cima</option>
            <option value="slideDown">Deslizar Baixo</option>
            <option value="zoom">Zoom</option>
            <option value="zoomRotate">Zoom + Rotação</option>
            <option value="flip">Flip</option>
            <option value="dissolve">Dissolve</option>
            <option value="wipeLeft">Wipe Esq.</option>
            <option value="wipeRight">Wipe Dir.</option>
        </select>
        <label>Dur. Trans.:</label>
        <input type="number" id="pageTransDuration" value="0.5" min="0.1" max="3" step="0.1" onchange="updateCurrentPageSetting('transitionDuration', parseFloat(this.value))"> <span>s</span>
        <div style="width:1px;height:20px;background:var(--panel-border);"></div>
        <label>Página:</label>
        <span id="pageIndicator" style="font-weight:600;">1 / 1</span>
        <div style="margin-left:auto; display:flex; gap:4px;">
            <button class="btn-editor btn-editor-outline" style="padding:2px 8px; font-size:11px;" onclick="duplicateCurrentPage()" title="Duplicar página">
                <i class="fas fa-clone"></i>
            </button>
        </div>
    </div>

    <!-- PAGE STRIP (FILMSTRIP) -->
    <div class="page-strip-container" id="pageStrip">
        <!-- Populated by JS -->
    </div>
</div>

<!-- Hidden file inputs -->
<input type="file" id="pptxUpload" accept=".pptx" style="display:none;" onchange="handlePPTXImport(event)">
<input type="file" id="audioUpload" accept="audio/*" style="display:none;" onchange="handleAudioUpload(event)">

<!-- Preview Modal -->
<div class="template-modal-overlay" id="previewModal">
    <div class="template-modal" style="padding:0; overflow:hidden; max-width:1200px;">
        <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 16px; background:var(--panel-surface);">
            <h5 style="color:#fff; margin:0;">Preview do Design</h5>
            <button onclick="closePreview()" style="background:none; border:none; color:#fff; font-size:18px; cursor:pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div style="background:#000; display:flex; align-items:center; justify-content:center; padding:20px;">
            <img id="previewImage" style="max-width:100%; max-height:70vh; border-radius:4px;">
        </div>
    </div>
</div>

<script>
// ═══════════════════════════════════════════════════════════════
//  DESIGN EDITOR — Fabric.js Canvas + Complete UI (v2 fixed)
// ═══════════════════════════════════════════════════════════════

(function() {
'use strict';

// ── CONFIG (let so they can be updated) ──
let CANVAS_W = {{ conteudo.design_largura|default:1920 }};
let CANVAS_H = {{ conteudo.design_altura|default:1080 }};

// Properly serialized JSON from view (json.dumps)
const EXISTING_JSON = {{ design_json_str|safe }};
let CONTEUDO_PK = {{ conteudo.pk|default:'null' }};

// Save URLs
const SAVE_URL_NEW = '{% url "design_save_new" %}';
let SAVE_URL_EDIT = {% if conteudo %}'{% url "design_save" pk=conteudo.pk %}'{% else %}null{% endif %};

// CSRF
const CSRF = '{{ csrf_token }}';

// ── STATE ──
let canvas;
let currentZoom = 1;
let undoStack = [];
let redoStack = [];
let isUndoRedoing = false;
let autoSaveTimer = null;
let isSaving = false;
let hasUnsavedChanges = false;
const AUTO_SAVE_DELAY = 30000; // 30 seconds

// ── MULTI-PAGE STATE ──
let pages = [];
let currentPageIdx = 0;

// ── COLORS ──
const COLORS = [
    '#ffffff', '#000000', '#f44336', '#e91e63', '#9c27b0', '#673ab7',
    '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50',
    '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800', '#ff5722',
    '#795548', '#607d8b', '#667eea', '#764ba2', '#f093fb', '#f5576c',
    '#43e97b', '#00f2fe', 'transparent'
];

// ── INIT ──
// applyZoomToFabric is at module level so zoom buttons and applyCanvasSize can call it
function applyZoomToFabric(zoom) {
    if (!canvas) return;
    const displayW = Math.round(CANVAS_W * zoom);
    const displayH = Math.round(CANVAS_H * zoom);
    canvas.setWidth(displayW);
    canvas.setHeight(displayH);
    canvas.setZoom(zoom);
    // No CSS transform — Fabric handles all coordinate math internally
    const wrapper = document.getElementById('canvasWrapper');
    if (wrapper) wrapper.style.transform = '';
    const el = document.getElementById('zoomLevel');
    if (el) el.textContent = Math.round(zoom * 100) + '%';
}

function init() {
    canvas = new fabric.Canvas('designCanvas', {
        width: CANVAS_W,
        height: CANVAS_H,
        backgroundColor: '#ffffff',
        preserveObjectStacking: true,
        selection: true,
    });

    // Sync design dimensions back to inputs and re-apply zoom to DOM canvas
    function enforceCanvasSize() {
        document.getElementById('canvasWidth').value = CANVAS_W;
        document.getElementById('canvasHeight').value = CANVAS_H;
        applyZoomToFabric(currentZoom);
    }

    // Load existing design (multi-page aware)
    if (EXISTING_JSON && typeof EXISTING_JSON === 'object') {
        if (EXISTING_JSON._version === 2 && EXISTING_JSON.pages) {
            // V2 multi-page format
            if (EXISTING_JSON._canvasWidth) CANVAS_W = EXISTING_JSON._canvasWidth;
            if (EXISTING_JSON._canvasHeight) CANVAS_H = EXISTING_JSON._canvasHeight;
            pages = EXISTING_JSON.pages.map(function(p, i) {
                return {
                    id: p.id || ('page_' + (i+1)),
                    name: p.name || ('Slide ' + (i+1)),
                    duration: p.duration || 5,
                    transition: p.transition || 'fade',
                    transitionDuration: p.transitionDuration || 0.5,
                    audioUrl: p.audioUrl || '',
                    fabricJson: p.fabricJson || null,
                    animations: p.animations || [],
                    _thumbnail: null
                };
            });
        } else {
            // Legacy single-canvas format → wrap in one page
            var legacyJson = Object.assign({}, EXISTING_JSON);
            if (legacyJson._canvasWidth) { CANVAS_W = legacyJson._canvasWidth; delete legacyJson._canvasWidth; }
            if (legacyJson._canvasHeight) { CANVAS_H = legacyJson._canvasHeight; delete legacyJson._canvasHeight; }
            delete legacyJson.width; delete legacyJson.height;
            pages = [{
                id: 'page_1', name: 'Slide 1',
                duration: parseInt(document.getElementById('designDuration').value) || 15,
                transition: 'fade', transitionDuration: 0.5,
                audioUrl: '', fabricJson: legacyJson, animations: [],
                _thumbnail: null
            }];
        }
    }
    if (pages.length === 0) {
        pages = [createNewPage('Slide 1')];
    }

    enforceCanvasSize();
    currentPageIdx = 0;
    loadPageIntoCanvas(0, function() {
        enforceCanvasSize();
        canvas.renderAll();
        updateLayers();
        saveUndoState();
        zoomFit();
        renderPageStrip();
        syncPageSettingsUI();
        console.log('[DesignEditor] Loaded ' + pages.length + ' page(s), ' + CANVAS_W + 'x' + CANVAS_H);
    });

    // Fit canvas after a short delay to ensure DOM is ready
    setTimeout(zoomFit, 200);

    // Events
    canvas.on('selection:created', onSelectionChange);
    canvas.on('selection:updated', onSelectionChange);
    canvas.on('selection:cleared', onSelectionClear);
    canvas.on('object:modified', onObjectModified);
    canvas.on('object:added', onObjectChange);
    canvas.on('object:removed', onObjectChange);
    canvas.on('text:changed', onObjectChange);

    // Color palette
    buildColorPalette();

    // Keyboard shortcuts
    document.addEventListener('keydown', handleKeyboard);

    // Window resize → refit
    window.addEventListener('resize', zoomFit);

    // Warn before leaving with unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
}

// ── AUTO-SAVE ──
function scheduleAutoSave() {
    hasUnsavedChanges = true;
    updateSaveIndicator();
    if (autoSaveTimer) clearTimeout(autoSaveTimer);
    autoSaveTimer = setTimeout(function() {
        const titulo = document.getElementById('designTitle').value.trim();
        if (titulo && !isSaving) {
            console.log('[DesignEditor] Auto-saving...');
            saveDesignSilent();
        }
    }, AUTO_SAVE_DELAY);
}

function updateSaveIndicator() {
    const indicator = document.getElementById('saveIndicator');
    if (!indicator) return;
    if (isSaving) {
        indicator.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Salvando...';
        indicator.style.color = '#ffc107';
    } else if (hasUnsavedChanges) {
        indicator.innerHTML = '<i class="fas fa-circle me-1" style="font-size:8px;"></i>Não salvo';
        indicator.style.color = '#ff6b6b';
    } else {
        indicator.innerHTML = '<i class="fas fa-check me-1"></i>Salvo';
        indicator.style.color = '#28a745';
    }
}

// ── COLOR PALETTE ──
function buildColorPalette() {
    const container = document.getElementById('colorPalette');
    container.innerHTML = '';
    COLORS.forEach(c => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        if (c === 'transparent') {
            swatch.style.background = 'linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%), linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%)';
            swatch.style.backgroundSize = '8px 8px';
            swatch.style.backgroundPosition = '0 0, 4px 4px';
        } else {
            swatch.style.background = c;
        }
        swatch.onclick = () => {
            const obj = canvas.getActiveObject();
            if (obj) {
                obj.set('fill', c);
                canvas.renderAll();
                saveUndoState();
                scheduleAutoSave();
            }
        };
        container.appendChild(swatch);
    });
}

// ── ZOOM ──
window.zoomIn = function() {
    currentZoom = Math.min(currentZoom + 0.1, 3);
    applyZoomToFabric(currentZoom);
};
window.zoomOut = function() {
    currentZoom = Math.max(currentZoom - 0.1, 0.1);
    applyZoomToFabric(currentZoom);
};
window.zoomFit = function() {
    const area = document.getElementById('canvasArea');
    if (!area) return;
    const aW = area.clientWidth - 40;
    const aH = area.clientHeight - 60;
    // Always divide by CANVAS_W/CANVAS_H (design dimensions), not canvas.getWidth()
    // which now returns the current display size instead of the design size
    const scaleW = aW / CANVAS_W;
    const scaleH = aH / CANVAS_H;
    currentZoom = Math.min(scaleW, scaleH, 1);
    applyZoomToFabric(currentZoom);
};

// ── ADD ELEMENTS ──
// Use CANVAS_W/CANVAS_H (design space), not canvas.getWidth() which is the display size
function getCenterX() { return CANVAS_W / 2; }
function getCenterY() { return CANVAS_H / 2; }

window.addText = function() {
    const text = new fabric.IText('Seu texto aqui', {
        left: getCenterX() - 100, top: getCenterY() - 20,
        fontFamily: 'Inter', fontSize: 36, fill: '#333333',
        fontWeight: 'normal', editable: true,
    });
    canvas.add(text);
    canvas.setActiveObject(text);
    canvas.renderAll();
};

window.addHeading = function() {
    const text = new fabric.IText('TÍTULO', {
        left: getCenterX() - 150, top: getCenterY() - 40,
        fontFamily: 'Inter', fontSize: 72, fill: '#111111',
        fontWeight: 'bold', editable: true,
    });
    canvas.add(text);
    canvas.setActiveObject(text);
    canvas.renderAll();
};

window.addSubtext = function() {
    const text = new fabric.IText('Subtítulo ou descrição', {
        left: getCenterX() - 120, top: getCenterY(),
        fontFamily: 'Inter', fontSize: 24, fill: '#666666',
        fontWeight: '300', editable: true,
    });
    canvas.add(text);
    canvas.setActiveObject(text);
    canvas.renderAll();
};

window.addRect = function() {
    const rect = new fabric.Rect({
        left: getCenterX() - 100, top: getCenterY() - 60,
        width: 200, height: 120, fill: '#667eea',
        rx: 0, ry: 0, strokeWidth: 0, stroke: 'transparent',
    });
    canvas.add(rect);
    canvas.setActiveObject(rect);
    canvas.renderAll();
};

window.addCircle = function() {
    const circle = new fabric.Circle({
        left: getCenterX() - 60, top: getCenterY() - 60,
        radius: 60, fill: '#764ba2',
        strokeWidth: 0, stroke: 'transparent',
    });
    canvas.add(circle);
    canvas.setActiveObject(circle);
    canvas.renderAll();
};

window.addTriangle = function() {
    const tri = new fabric.Triangle({
        left: getCenterX() - 50, top: getCenterY() - 50,
        width: 100, height: 100, fill: '#f5576c',
        strokeWidth: 0, stroke: 'transparent',
    });
    canvas.add(tri);
    canvas.setActiveObject(tri);
    canvas.renderAll();
};

window.addLine = function() {
    const cx = getCenterX(), cy = getCenterY();
    const line = new fabric.Line([cx - 100, cy, cx + 100, cy], {
        stroke: '#333333', strokeWidth: 3, selectable: true,
    });
    canvas.add(line);
    canvas.setActiveObject(line);
    canvas.renderAll();
};

window.addStar = function() {
    const points = createStarPoints(5, 60, 30);
    const star = new fabric.Polygon(points, {
        left: getCenterX() - 60, top: getCenterY() - 60,
        fill: '#ffc107', strokeWidth: 0, stroke: 'transparent',
    });
    canvas.add(star);
    canvas.setActiveObject(star);
    canvas.renderAll();
};

function createStarPoints(spikes, outerR, innerR) {
    const points = [];
    const step = Math.PI / spikes;
    let rot = Math.PI / 2 * 3;
    for (let i = 0; i < spikes; i++) {
        points.push({ x: outerR + Math.cos(rot) * outerR, y: outerR + Math.sin(rot) * outerR });
        rot += step;
        points.push({ x: outerR + Math.cos(rot) * innerR, y: outerR + Math.sin(rot) * innerR });
        rot += step;
    }
    return points;
}

window.addRoundedRect = function() {
    const rect = new fabric.Rect({
        left: getCenterX() - 100, top: getCenterY() - 60,
        width: 200, height: 120, fill: '#00bcd4',
        rx: 16, ry: 16, strokeWidth: 0, stroke: 'transparent',
    });
    canvas.add(rect);
    canvas.setActiveObject(rect);
    canvas.renderAll();
};

window.addDiamond = function() {
    const points = [
        { x: 60, y: 0 }, { x: 120, y: 60 },
        { x: 60, y: 120 }, { x: 0, y: 60 },
    ];
    const diamond = new fabric.Polygon(points, {
        left: getCenterX() - 60, top: getCenterY() - 60,
        fill: '#e91e63', strokeWidth: 0, stroke: 'transparent',
    });
    canvas.add(diamond);
    canvas.setActiveObject(diamond);
    canvas.renderAll();
};

window.addArrow = function() {
    const points = [
        { x: 0, y: 20 }, { x: 80, y: 20 }, { x: 80, y: 0 },
        { x: 120, y: 30 }, { x: 80, y: 60 }, { x: 80, y: 40 }, { x: 0, y: 40 },
    ];
    const arrow = new fabric.Polygon(points, {
        left: getCenterX() - 60, top: getCenterY() - 30,
        fill: '#ff9800', strokeWidth: 0, stroke: 'transparent',
    });
    canvas.add(arrow);
    canvas.setActiveObject(arrow);
    canvas.renderAll();
};

// ── IMAGE UPLOAD ──
window.triggerImageUpload = function() {
    document.getElementById('imageUpload').click();
};
window.handleImageUpload = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
        fabric.Image.fromURL(evt.target.result, function(img) {
            var maxW = CANVAS_W * 0.5;
            var maxH = CANVAS_H * 0.5;
            var scale = Math.min(maxW / img.width, maxH / img.height, 1);
            img.set({
                left: CANVAS_W / 2 - (img.width * scale) / 2,
                top: CANVAS_H / 2 - (img.height * scale) / 2,
                scaleX: scale, scaleY: scale,
            });
            canvas.add(img);
            canvas.setActiveObject(img);
            canvas.renderAll();
        });
    };
    reader.readAsDataURL(file);
    e.target.value = '';
};

// ── BACKGROUND ──
window.setCanvasBgColor = function() {
    const color = document.getElementById('customColor').value;
    canvas.setBackgroundImage(null, function() {
        canvas.setBackgroundColor(color, function() {
            canvas.renderAll();
            saveUndoState();
            scheduleAutoSave();
        });
    });
};

window.setBgGradient = function(gradientCSS) {
    const match = gradientCSS.match(/#[0-9a-fA-F]{6}/g);
    if (match && match.length >= 2) {
        var grad = new fabric.Gradient({
            type: 'linear',
            coords: { x1: 0, y1: 0, x2: CANVAS_W, y2: CANVAS_H },
            colorStops: [
                { offset: 0, color: match[0] },
                { offset: 1, color: match[1] },
            ]
        });
        canvas.setBackgroundImage(null, function() {
            canvas.setBackgroundColor(grad, function() {
                canvas.renderAll();
                saveUndoState();
                scheduleAutoSave();
            });
        });
    }
};

window.triggerBgImageUpload = function() {
    document.getElementById('bgImageUpload').click();
};
window.handleBgImageUpload = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
        fabric.Image.fromURL(evt.target.result, function(img) {
            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                scaleX: CANVAS_W / img.width,
                scaleY: CANVAS_H / img.height,
                originX: 'left', originY: 'top',
            });
            saveUndoState();
            scheduleAutoSave();
        });
    };
    reader.readAsDataURL(file);
    e.target.value = '';
};

// ── CUSTOM COLOR APPLY ──
window.applyCustomColor = function(prop) {
    const color = document.getElementById('customColor').value;
    const obj = canvas.getActiveObject();
    if (!obj) return;
    obj.set(prop, color);
    canvas.renderAll();
    saveUndoState();
    scheduleAutoSave();
};

// ── PROPERTIES PANEL ──
function onSelectionChange() {
    const obj = canvas.getActiveObject();
    if (!obj) return;
    showPropertiesFor(obj);
    showAnimationPanel(obj);
    updateLayers();
}
function onSelectionClear() {
    document.getElementById('propsPanel').style.display = 'none';
    document.getElementById('textPropsPanel').style.display = 'none';
    document.getElementById('shapePropsPanel').style.display = 'none';
    document.getElementById('alignPanel').style.display = 'none';
    document.getElementById('actionsPanel').style.display = 'none';
    document.getElementById('animPanel').style.display = 'none';
}
function showPropertiesFor(obj) {
    document.getElementById('propsPanel').style.display = 'block';
    document.getElementById('alignPanel').style.display = 'block';
    document.getElementById('actionsPanel').style.display = 'block';
    document.getElementById('propX').value = Math.round(obj.left);
    document.getElementById('propY').value = Math.round(obj.top);
    document.getElementById('propW').value = Math.round(obj.getScaledWidth());
    document.getElementById('propH').value = Math.round(obj.getScaledHeight());
    document.getElementById('propAngle').value = Math.round(obj.angle);
    document.getElementById('propOpacity').value = Math.round(obj.opacity * 100);

    const isText = obj.type === 'i-text' || obj.type === 'textbox';
    document.getElementById('textPropsPanel').style.display = isText ? 'block' : 'none';
    if (isText) {
        document.getElementById('propFont').value = obj.fontFamily || 'Inter';
        document.getElementById('propFontSize').value = obj.fontSize || 36;
        document.getElementById('propFontWeight').value = obj.fontWeight || 'normal';
        document.getElementById('propTextColor').value = obj.fill || '#333333';
        document.getElementById('propLineHeight').value = obj.lineHeight || 1.16;
        document.getElementById('btnBold').classList.toggle('active', obj.fontWeight === 'bold' || parseInt(obj.fontWeight) >= 700);
        document.getElementById('btnItalic').classList.toggle('active', obj.fontStyle === 'italic');
        document.getElementById('btnUnderline').classList.toggle('active', !!obj.underline);
        document.getElementById('btnStrikethrough').classList.toggle('active', !!obj.linethrough);
    }

    const isShape = !isText && obj.type !== 'image';
    document.getElementById('shapePropsPanel').style.display = isShape ? 'block' : 'none';
    if (isShape) {
        document.getElementById('propFillColor').value = colorToHex(obj.fill) || '#667eea';
        document.getElementById('propStrokeColor').value = colorToHex(obj.stroke) || '#000000';
        document.getElementById('propStrokeWidth').value = obj.strokeWidth || 0;
        document.getElementById('propBorderRadius').value = obj.rx || 0;
    }
}

function colorToHex(color) {
    if (!color || color === 'transparent') return '#000000';
    if (typeof color === 'object') return '#000000'; // gradient
    if (typeof color === 'string' && color.startsWith('#')) return color.substring(0, 7);
    const temp = document.createElement('div');
    temp.style.color = color;
    document.body.appendChild(temp);
    const computed = getComputedStyle(temp).color;
    document.body.removeChild(temp);
    const m = computed.match(/(\d+)/g);
    if (m) return '#' + m.slice(0, 3).map(x => (+x).toString(16).padStart(2, '0')).join('');
    return '#000000';
}

// ── UPDATE PROPERTIES ──
window.updateObjProp = function(prop, value) {
    const obj = canvas.getActiveObject();
    if (!obj) return;
    obj.set(prop, parseFloat(value));
    canvas.renderAll();
    saveUndoState();
    scheduleAutoSave();
};
window.updateObjScale = function(dim, value) {
    const obj = canvas.getActiveObject();
    if (!obj) return;
    const v = parseFloat(value);
    if (dim === 'width') obj.set('scaleX', v / (obj.width || 1));
    else obj.set('scaleY', v / (obj.height || 1));
    canvas.renderAll();
    saveUndoState();
    scheduleAutoSave();
};
window.updateTextProp = function(prop, value) {
    const obj = canvas.getActiveObject();
    if (!obj) return;
    obj.set(prop, value);
    canvas.renderAll();
    showPropertiesFor(obj);
    saveUndoState();
    scheduleAutoSave();
};
window.updateShapeProp = function(prop, value) {
    const obj = canvas.getActiveObject();
    if (!obj) return;
    obj.set(prop, value);
    canvas.renderAll();
    saveUndoState();
    scheduleAutoSave();
};
window.updateShapeBorderRadius = function(val) {
    const obj = canvas.getActiveObject();
    if (!obj || obj.type !== 'rect') return;
    obj.set({ rx: parseInt(val), ry: parseInt(val) });
    canvas.renderAll();
    saveUndoState();
    scheduleAutoSave();
};

// ── TEXT FORMATTING ──
window.toggleBold = function() {
    const obj = canvas.getActiveObject();
    if (!obj) return;
    const isBold = obj.fontWeight === 'bold' || parseInt(obj.fontWeight) >= 700;
    obj.set('fontWeight', isBold ? 'normal' : 'bold');
    canvas.renderAll();
    showPropertiesFor(obj);
    saveUndoState();
    scheduleAutoSave();
};
window.toggleItalic = function() {
    const obj = canvas.getActiveObject();
    if (!obj) return;
    obj.set('fontStyle', obj.fontStyle === 'italic' ? 'normal' : 'italic');
    canvas.renderAll();
    showPropertiesFor(obj);
    saveUndoState();
    scheduleAutoSave();
};
window.toggleUnderline = function() {
    const obj = canvas.getActiveObject();
    if (!obj) return;
    obj.set('underline', !obj.underline);
    canvas.renderAll();
    showPropertiesFor(obj);
    saveUndoState();
    scheduleAutoSave();
};
window.toggleStrikethrough = function() {
    const obj = canvas.getActiveObject();
    if (!obj) return;
    obj.set('linethrough', !obj.linethrough);
    canvas.renderAll();
    showPropertiesFor(obj);
    saveUndoState();
    scheduleAutoSave();
};
window.setTextAlign = function(align) {
    const obj = canvas.getActiveObject();
    if (!obj) return;
    obj.set('textAlign', align);
    canvas.renderAll();
    saveUndoState();
    scheduleAutoSave();
};

// ── ALIGNMENT ──
window.alignObject = function(type) {
    const obj = canvas.getActiveObject();
    if (!obj) return;
    const cW = CANVAS_W, cH = CANVAS_H;  // design dimensions, not display size
    switch (type) {
        case 'left': obj.set('left', 0); break;
        case 'right': obj.set('left', cW - obj.getScaledWidth()); break;
        case 'centerH': obj.set('left', (cW - obj.getScaledWidth()) / 2); break;
        case 'top': obj.set('top', 0); break;
        case 'bottom': obj.set('top', cH - obj.getScaledHeight()); break;
        case 'centerV': obj.set('top', (cH - obj.getScaledHeight()) / 2); break;
    }
    obj.setCoords();
    canvas.renderAll();
    saveUndoState();
    scheduleAutoSave();
};

// ── OBJECT ACTIONS ──
window.bringForward = function() {
    const obj = canvas.getActiveObject();
    if (obj) { canvas.bringForward(obj); updateLayers(); saveUndoState(); scheduleAutoSave(); }
};
window.sendBackward = function() {
    const obj = canvas.getActiveObject();
    if (obj) { canvas.sendBackwards(obj); updateLayers(); saveUndoState(); scheduleAutoSave(); }
};
window.duplicateObject = function() {
    const obj = canvas.getActiveObject();
    if (!obj) return;
    obj.clone(function(cloned) {
        cloned.set({ left: obj.left + 20, top: obj.top + 20 });
        canvas.add(cloned);
        canvas.setActiveObject(cloned);
        canvas.renderAll();
    });
};
window.deleteObject = function() {
    const obj = canvas.getActiveObject();
    if (obj) {
        canvas.remove(obj);
        canvas.renderAll();
        onSelectionClear();
    }
};

// ── LAYERS ──
function updateLayers() {
    const list = document.getElementById('layersList');
    const objects = canvas.getObjects();
    const active = canvas.getActiveObject();

    if (objects.length === 0) {
        list.innerHTML = '<div style="text-align:center; color:var(--panel-text-muted); font-size:12px; padding:12px;">Nenhum elemento no canvas</div>';
        return;
    }

    let html = '';
    for (let i = objects.length - 1; i >= 0; i--) {
        const obj = objects[i];
        const isSelected = active === obj;
        const icon = getLayerIcon(obj);
        const name = getLayerName(obj, i);
        html += '<div class="layer-item ' + (isSelected ? 'selected' : '') + '" onclick="selectLayer(' + i + ')">' +
            '<span class="layer-icon"><i class="' + icon + '"></i></span>' +
            '<span class="layer-name">' + name + '</span>' +
            '<span class="layer-actions">' +
            '<button onclick="event.stopPropagation(); toggleLayerVisibility(' + i + ')" title="Visibilidade">' +
            '<i class="fas fa-' + (obj.visible !== false ? 'eye' : 'eye-slash') + '"></i>' +
            '</button></span></div>';
    }
    list.innerHTML = html;
}

function getLayerIcon(obj) {
    switch (obj.type) {
        case 'i-text': case 'textbox': return 'fas fa-font';
        case 'rect': return 'far fa-square';
        case 'circle': return 'far fa-circle';
        case 'triangle': return 'fas fa-play fa-rotate-270';
        case 'polygon': return 'fas fa-shapes';
        case 'line': return 'fas fa-minus';
        case 'image': return 'fas fa-image';
        default: return 'fas fa-cube';
    }
}

function getLayerName(obj, idx) {
    if (obj.type === 'i-text' || obj.type === 'textbox') {
        const txt = (obj.text || '').replace(/</g, '&lt;');
        return txt.substring(0, 20) + (txt.length > 20 ? '...' : '');
    }
    const typeMap = { rect: 'Retângulo', circle: 'Círculo', triangle: 'Triângulo', line: 'Linha', polygon: 'Forma', image: 'Imagem' };
    return (typeMap[obj.type] || 'Objeto') + ' ' + (idx + 1);
}

window.selectLayer = function(idx) {
    const obj = canvas.getObjects()[idx];
    if (obj) { canvas.setActiveObject(obj); canvas.renderAll(); }
};
window.toggleLayerVisibility = function(idx) {
    const obj = canvas.getObjects()[idx];
    if (obj) {
        obj.visible = !obj.visible;
        canvas.renderAll();
        updateLayers();
        saveUndoState();
        scheduleAutoSave();
    }
};

function onObjectModified() {
    const obj = canvas.getActiveObject();
    if (obj) showPropertiesFor(obj);
    saveUndoState();
    updateLayers();
    scheduleAutoSave();
}
function onObjectChange() {
    if (!isUndoRedoing) {
        saveUndoState();
        scheduleAutoSave();
    }
    updateLayers();
}

// ── UNDO / REDO ──
function saveUndoState() {
    if (isUndoRedoing) return;
    const json = JSON.stringify(canvas.toJSON());
    undoStack.push(json);
    if (undoStack.length > 50) undoStack.shift();
    redoStack = [];
}
window.undoAction = function() {
    if (undoStack.length <= 1) return;
    isUndoRedoing = true;
    redoStack.push(undoStack.pop());
    const prev = undoStack[undoStack.length - 1];
    canvas.loadFromJSON(prev, function() {
        canvas.renderAll();
        updateLayers();
        isUndoRedoing = false;
        scheduleAutoSave();
    });
};
window.redoAction = function() {
    if (redoStack.length === 0) return;
    isUndoRedoing = true;
    const next = redoStack.pop();
    undoStack.push(next);
    canvas.loadFromJSON(next, function() {
        canvas.renderAll();
        updateLayers();
        isUndoRedoing = false;
        scheduleAutoSave();
    });
};

// ── SETTINGS ──
window.toggleSettings = function() {
    document.getElementById('settingsDropdown').classList.toggle('show');
};
window.applyCanvasSize = function() {
    const w = parseInt(document.getElementById('canvasWidth').value) || 1920;
    const h = parseInt(document.getElementById('canvasHeight').value) || 1080;
    CANVAS_W = w;
    CANVAS_H = h;
    // zoomFit recalculates zoom and calls applyZoomToFabric which sets the DOM size
    zoomFit();
    canvas.renderAll();
    document.getElementById('settingsDropdown').classList.remove('show');
    showToast('Dimensões atualizadas: ' + w + '×' + h + 'px');
    scheduleAutoSave();
};

// ── KEYBOARD ──
function handleKeyboard(e) {
    if (e.key === 'Delete' || e.key === 'Backspace') {
        const obj = canvas.getActiveObject();
        if (obj && !obj.isEditing) {
            canvas.remove(obj);
            canvas.renderAll();
            onSelectionClear();
            e.preventDefault();
        }
    }
    if (e.ctrlKey && e.key === 'z') { undoAction(); e.preventDefault(); }
    if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'Z')) { redoAction(); e.preventDefault(); }
    if (e.ctrlKey && e.key === 'd') { duplicateObject(); e.preventDefault(); }
    if (e.ctrlKey && e.key === 's') { saveDesign(); e.preventDefault(); }
}

// ── PREVIEW ──
window.previewDesign = function() {
    // Se o design já foi salvo, abre a visualização TV completa com transições
    if (CONTEUDO_PK) {
        window.open(`/corporativo/design/${CONTEUDO_PK}/render/`, '_blank');
    } else {
        alert('Por favor, salve o design primeiro para visualizar com transições.');
    }
};
window.closePreview = function() {
    document.getElementById('previewModal').classList.remove('show');
};

// ── SAVE (manual, with UI feedback) ──
window.saveDesign = function() {
    const titulo = document.getElementById('designTitle').value.trim();
    if (!titulo) {
        showToast('Preencha o nome do design!', true);
        return;
    }
    performSave(titulo, true);
};

// ── SAVE (silent, for auto-save) ──
function saveDesignSilent() {
    const titulo = document.getElementById('designTitle').value.trim();
    if (!titulo || isSaving) return;
    performSave(titulo, false);
}

function performSave(titulo, showFeedback) {
    if (isSaving) return;
    isSaving = true;

    const btn = document.getElementById('btnSave');
    if (showFeedback) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Salvando...';
    }
    updateSaveIndicator();

    // CANVAS_W/CANVAS_H are always the design dimensions (canvas.getWidth() is display size)
    const largura = CANVAS_W;
    const altura = CANVAS_H;
    document.getElementById('canvasWidth').value = largura;
    document.getElementById('canvasHeight').value = altura;

    // Save current page state before serializing
    saveCurrentPageState();

    // Build v2 multi-page JSON
    const designJSON = {
        _version: 2,
        _canvasWidth: largura,
        _canvasHeight: altura,
        pages: pages.map(function(p) {
            return {
                id: p.id,
                name: p.name,
                duration: p.duration,
                transition: p.transition,
                transitionDuration: p.transitionDuration,
                audioUrl: p.audioUrl,
                fabricJson: p.fabricJson,
                animations: p.animations
            };
        })
    };
    const thumbnailURL = canvas.toDataURL({ format: 'png', multiplier: 0.3 });
    const duracao = parseInt(document.getElementById('designDuration').value) || 15;
    const isTemplate = document.getElementById('isTemplate').value === '1';
    const templateCat = document.getElementById('templateCategoria').value.trim();

    // Build URL - use existing PK URL if available
    let url;
    if (CONTEUDO_PK && SAVE_URL_EDIT) {
        url = SAVE_URL_EDIT;
    } else {
        url = SAVE_URL_NEW;
    }

    const payload = {
        titulo: titulo,
        design_json: designJSON,
        thumbnail: thumbnailURL,
        largura: largura,
        altura: altura,
        duracao_segundos: duracao,
        is_template: isTemplate,
        template_categoria: templateCat,
    };

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': CSRF,
        },
        body: JSON.stringify(payload),
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            hasUnsavedChanges = false;
            if (showFeedback) showToast(data.message);

            // If was a new design, update PK and URL without redirecting
            if (!CONTEUDO_PK && data.id) {
                CONTEUDO_PK = data.id;
                SAVE_URL_EDIT = '/corporativo/design/' + data.id + '/save/';
                // Update browser URL without reload
                if (window.history && window.history.replaceState) {
                    window.history.replaceState(null, '', '/corporativo/design/' + data.id + '/edit/');
                }
                console.log('[DesignEditor] New design saved with PK:', data.id);
            }
        } else {
            if (showFeedback) showToast(data.message || 'Erro ao salvar', true);
        }
    })
    .catch(function(err) {
        if (showFeedback) showToast('Erro de conexão: ' + err.message, true);
        console.error('[DesignEditor] Save error:', err);
    })
    .finally(function() {
        isSaving = false;
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save me-1"></i>Salvar';
        updateSaveIndicator();
    });
}

function showToast(msg, isError) {
    const toast = document.getElementById('saveToast');
    toast.textContent = msg;
    toast.className = 'save-toast show' + (isError ? ' error' : '');
    setTimeout(function() { toast.classList.remove('show'); }, 3000);
}

// ═══════════════════════════════════════════════════════════════
//  MULTI-PAGE MANAGEMENT
// ═══════════════════════════════════════════════════════════════

function createNewPage(name) {
    return {
        id: 'page_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
        name: name || ('Slide ' + (pages.length + 1)),
        duration: 5,
        transition: 'fade',
        transitionDuration: 0.5,
        audioUrl: '',
        fabricJson: null,
        animations: [],
        _thumbnail: null
    };
}

function saveCurrentPageState() {
    if (!canvas || pages.length === 0) return;
    var json = canvas.toJSON();
    delete json.width; delete json.height;
    pages[currentPageIdx].fabricJson = json;
    // Capture thumbnail
    try {
        pages[currentPageIdx]._thumbnail = canvas.toDataURL({ format: 'png', multiplier: 0.15 });
    } catch(e) {}
}

function loadPageIntoCanvas(idx, cb) {
    var page = pages[idx];
    if (!page) { if (cb) cb(); return; }
    if (page.fabricJson) {
        var json = JSON.parse(JSON.stringify(page.fabricJson));
        delete json.width; delete json.height;
        canvas.loadFromJSON(json, function() {
            canvas.setWidth(Math.round(CANVAS_W * currentZoom));
            canvas.setHeight(Math.round(CANVAS_H * currentZoom));
            canvas.setZoom(currentZoom);
            canvas.renderAll();
            if (cb) cb();
        });
    } else {
        canvas.clear();
        canvas.setBackgroundColor('#ffffff', function() {
            canvas.renderAll();
            if (cb) cb();
        });
    }
}

window.switchToPage = function(idx) {
    if (idx === currentPageIdx || idx < 0 || idx >= pages.length) return;
    // Save current page
    saveCurrentPageState();
    // Clear undo history for new page
    undoStack = [];
    redoStack = [];
    currentPageIdx = idx;
    loadPageIntoCanvas(idx, function() {
        canvas.renderAll();
        updateLayers();
        saveUndoState();
        renderPageStrip();
        syncPageSettingsUI();
        onSelectionClear();
    });
};

window.addNewPage = function() {
    saveCurrentPageState();
    var newPage = createNewPage('Slide ' + (pages.length + 1));
    pages.push(newPage);
    switchToPage(pages.length - 1);
    scheduleAutoSave();
};

window.duplicateCurrentPage = function() {
    saveCurrentPageState();
    var src = pages[currentPageIdx];
    var dup = {
        id: 'page_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
        name: src.name + ' (cópia)',
        duration: src.duration,
        transition: src.transition,
        transitionDuration: src.transitionDuration,
        audioUrl: src.audioUrl,
        fabricJson: src.fabricJson ? JSON.parse(JSON.stringify(src.fabricJson)) : null,
        animations: src.animations ? JSON.parse(JSON.stringify(src.animations)) : [],
        _thumbnail: src._thumbnail
    };
    pages.splice(currentPageIdx + 1, 0, dup);
    switchToPage(currentPageIdx + 1);
    scheduleAutoSave();
};

window.deletePage = function(idx) {
    if (pages.length <= 1) {
        showToast('Deve haver pelo menos uma página', true);
        return;
    }
    pages.splice(idx, 1);
    if (currentPageIdx >= pages.length) currentPageIdx = pages.length - 1;
    if (idx === currentPageIdx || currentPageIdx >= pages.length) {
        currentPageIdx = Math.min(currentPageIdx, pages.length - 1);
        loadPageIntoCanvas(currentPageIdx, function() {
            canvas.renderAll();
            updateLayers();
            undoStack = []; redoStack = [];
            saveUndoState();
            renderPageStrip();
            syncPageSettingsUI();
        });
    } else {
        if (idx < currentPageIdx) currentPageIdx--;
        renderPageStrip();
        syncPageSettingsUI();
    }
    scheduleAutoSave();
};

function renderPageStrip() {
    var strip = document.getElementById('pageStrip');
    strip.innerHTML = '';

    pages.forEach(function(page, idx) {
        var thumb = document.createElement('div');
        thumb.className = 'page-thumb' + (idx === currentPageIdx ? ' active' : '');
        thumb.onclick = function() { switchToPage(idx); };

        if (page._thumbnail) {
            var img = document.createElement('img');
            img.src = page._thumbnail;
            thumb.appendChild(img);
        } else {
            var ph = document.createElement('div');
            ph.style.cssText = 'width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--panel-text-muted);font-size:24px;';
            ph.innerHTML = '<i class="far fa-square"></i>';
            thumb.appendChild(ph);
        }

        var label = document.createElement('div');
        label.className = 'page-thumb-label';
        label.textContent = page.name || ('Slide ' + (idx + 1));
        thumb.appendChild(label);

        var dur = document.createElement('div');
        dur.className = 'page-thumb-duration';
        dur.textContent = (page.duration || 5) + 's';
        thumb.appendChild(dur);

        if (pages.length > 1) {
            var del = document.createElement('button');
            del.className = 'page-thumb-delete';
            del.innerHTML = '&times;';
            del.onclick = function(e) { e.stopPropagation(); deletePage(idx); };
            thumb.appendChild(del);
        }

        strip.appendChild(thumb);
    });

    var addBtn = document.createElement('button');
    addBtn.className = 'page-add-btn';
    addBtn.onclick = addNewPage;
    addBtn.title = 'Adicionar página';
    addBtn.innerHTML = '<i class="fas fa-plus"></i>';
    strip.appendChild(addBtn);

    // Update page indicator
    var ind = document.getElementById('pageIndicator');
    if (ind) ind.textContent = (currentPageIdx + 1) + ' / ' + pages.length;
}

function syncPageSettingsUI() {
    var page = pages[currentPageIdx];
    if (!page) return;
    document.getElementById('pageDuration').value = page.duration || 5;
    document.getElementById('pageTransition').value = page.transition || 'fade';
    document.getElementById('pageTransDuration').value = page.transitionDuration || 0.5;
    // Audio
    var af = document.getElementById('audioFilename');
    var ap = document.getElementById('audioPreview');
    if (page.audioUrl) {
        af.textContent = page.audioUrl.split('/').pop();
        ap.src = page.audioUrl;
        ap.style.display = 'block';
    } else {
        af.textContent = 'Sem áudio';
        ap.src = '';
        ap.style.display = 'none';
    }
}

window.updateCurrentPageSetting = function(key, value) {
    if (!pages[currentPageIdx]) return;
    pages[currentPageIdx][key] = value;
    renderPageStrip();
    scheduleAutoSave();
};

// ═══════════════════════════════════════════════════════════════
//  ANIMATION MANAGEMENT (per object, per page)
// ═══════════════════════════════════════════════════════════════

function showAnimationPanel(obj) {
    var panel = document.getElementById('animPanel');
    if (!obj) { panel.style.display = 'none'; return; }
    panel.style.display = 'block';
    var idx = canvas.getObjects().indexOf(obj);
    var page = pages[currentPageIdx];
    var anim = null;
    if (page && page.animations) {
        anim = page.animations.find(function(a) { return a.objectIndex === idx; });
    }
    document.getElementById('animType').value = anim ? anim.type : 'none';
    document.getElementById('animDelay').value = anim ? anim.delay : 0;
    document.getElementById('animDuration').value = anim ? anim.duration : 1;
    document.getElementById('animEasing').value = anim ? (anim.easing || 'easeInOut') : 'easeInOut';
}

window.updateSelectedObjectAnimation = function() {
    var obj = canvas.getActiveObject();
    if (!obj) return;
    var idx = canvas.getObjects().indexOf(obj);
    var page = pages[currentPageIdx];
    if (!page) return;
    if (!page.animations) page.animations = [];

    var type = document.getElementById('animType').value;
    var delay = parseFloat(document.getElementById('animDelay').value) || 0;
    var duration = parseFloat(document.getElementById('animDuration').value) || 1;
    var easing = document.getElementById('animEasing').value || 'easeInOut';

    // Remove old entry for this object
    page.animations = page.animations.filter(function(a) { return a.objectIndex !== idx; });

    if (type !== 'none') {
        page.animations.push({ objectIndex: idx, type: type, delay: delay, duration: duration, easing: easing });
    }
    scheduleAutoSave();
};

// ── Animation Preview (plays the selected animation on canvas) ──
window.previewAnimation = function() {
    var obj = canvas.getActiveObject();
    if (!obj) { showToast('Selecione um objeto primeiro', true); return; }

    var type = document.getElementById('animType').value;
    var delay = (parseFloat(document.getElementById('animDelay').value) || 0) * 1000;
    var duration = (parseFloat(document.getElementById('animDuration').value) || 1) * 1000;
    var easingName = document.getElementById('animEasing').value || 'easeInOut';

    if (type === 'none') { showToast('Selecione um tipo de animação', true); return; }

    // Save original state
    var orig = {
        left: obj.left, top: obj.top,
        scaleX: obj.scaleX, scaleY: obj.scaleY,
        opacity: obj.opacity, angle: obj.angle,
    };

    var easingFn = fabric.util.ease['easeInOutCubic'];
    var easingMap = {
        'linear': fabric.util.ease.easeLinear || null,
        'easeIn': fabric.util.ease.easeInCubic,
        'easeOut': fabric.util.ease.easeOutCubic,
        'easeInOut': fabric.util.ease.easeInOutCubic,
        'easeOutBounce': fabric.util.ease.easeOutBounce,
        'easeOutElastic': fabric.util.ease.easeOutElastic,
        'easeOutBack': fabric.util.ease.easeOutBack,
    };
    if (easingMap[easingName]) easingFn = easingMap[easingName];

    function restoreObj() {
        obj.set(orig);
        obj.setCoords();
        canvas.renderAll();
    }

    function runAnim() {
        // Set starting state based on animation type
        switch(type) {
            case 'fadeIn':
                obj.set({ opacity: 0 });
                canvas.renderAll();
                obj.animate('opacity', orig.opacity, { duration: duration, easing: easingFn, onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj });
                break;
            case 'slideLeft':
                obj.set({ left: -obj.getScaledWidth() });
                canvas.renderAll();
                obj.animate('left', orig.left, { duration: duration, easing: easingFn, onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj });
                break;
            case 'slideRight':
                obj.set({ left: CANVAS_W + 50 });
                canvas.renderAll();
                obj.animate('left', orig.left, { duration: duration, easing: easingFn, onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj });
                break;
            case 'slideUp':
                obj.set({ top: CANVAS_H + 50 });
                canvas.renderAll();
                obj.animate('top', orig.top, { duration: duration, easing: easingFn, onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj });
                break;
            case 'slideDown':
                obj.set({ top: -obj.getScaledHeight() });
                canvas.renderAll();
                obj.animate('top', orig.top, { duration: duration, easing: easingFn, onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj });
                break;
            case 'zoomIn':
                obj.set({ scaleX: 0.01, scaleY: 0.01, opacity: 0 });
                canvas.renderAll();
                obj.animate({ scaleX: orig.scaleX, scaleY: orig.scaleY, opacity: orig.opacity }, { duration: duration, easing: easingFn, onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj });
                break;
            case 'zoomOut':
                obj.set({ scaleX: orig.scaleX * 3, scaleY: orig.scaleY * 3, opacity: 0 });
                canvas.renderAll();
                obj.animate({ scaleX: orig.scaleX, scaleY: orig.scaleY, opacity: orig.opacity }, { duration: duration, easing: easingFn, onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj });
                break;
            case 'bounceIn':
                obj.set({ scaleX: 0.01, scaleY: 0.01 });
                canvas.renderAll();
                obj.animate({ scaleX: orig.scaleX, scaleY: orig.scaleY }, {
                    duration: duration,
                    easing: fabric.util.ease.easeOutBounce,
                    onChange: canvas.renderAll.bind(canvas),
                    onComplete: restoreObj
                });
                break;
            case 'rotateIn':
                obj.set({ angle: orig.angle - 180, opacity: 0, scaleX: 0.01, scaleY: 0.01 });
                canvas.renderAll();
                obj.animate({ angle: orig.angle, opacity: orig.opacity, scaleX: orig.scaleX, scaleY: orig.scaleY }, { duration: duration, easing: easingFn, onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj });
                break;
            case 'flipIn':
                obj.set({ scaleX: 0.01, opacity: 0 });
                canvas.renderAll();
                obj.animate({ scaleX: orig.scaleX, opacity: orig.opacity }, { duration: duration, easing: easingFn, onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj });
                break;
            case 'pulse':
                obj.animate({ scaleX: orig.scaleX * 1.15, scaleY: orig.scaleY * 1.15 }, {
                    duration: duration / 2, easing: easingFn,
                    onChange: canvas.renderAll.bind(canvas),
                    onComplete: function() {
                        obj.animate({ scaleX: orig.scaleX, scaleY: orig.scaleY }, {
                            duration: duration / 2, easing: easingFn,
                            onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj
                        });
                    }
                });
                break;
            case 'shake':
                var shakeSeq = [orig.left + 15, orig.left - 15, orig.left + 10, orig.left - 10, orig.left + 5, orig.left];
                var step = 0;
                function doShake() {
                    if (step >= shakeSeq.length) { restoreObj(); return; }
                    obj.animate('left', shakeSeq[step], {
                        duration: duration / shakeSeq.length, onChange: canvas.renderAll.bind(canvas),
                        onComplete: function() { step++; doShake(); }
                    });
                }
                doShake();
                break;
            case 'swing':
                obj.animate('angle', orig.angle + 15, {
                    duration: duration / 4, easing: easingFn, onChange: canvas.renderAll.bind(canvas),
                    onComplete: function() {
                        obj.animate('angle', orig.angle - 10, { duration: duration / 4, easing: easingFn, onChange: canvas.renderAll.bind(canvas),
                            onComplete: function() {
                                obj.animate('angle', orig.angle + 5, { duration: duration / 4, easing: easingFn, onChange: canvas.renderAll.bind(canvas),
                                    onComplete: function() {
                                        obj.animate('angle', orig.angle, { duration: duration / 4, easing: easingFn, onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj });
                                    }
                                });
                            }
                        });
                    }
                });
                break;
            case 'rubberBand':
                obj.animate({ scaleX: orig.scaleX * 1.25, scaleY: orig.scaleY * 0.75 }, {
                    duration: duration / 3, easing: easingFn, onChange: canvas.renderAll.bind(canvas),
                    onComplete: function() {
                        obj.animate({ scaleX: orig.scaleX * 0.75, scaleY: orig.scaleY * 1.25 }, {
                            duration: duration / 3, easing: easingFn, onChange: canvas.renderAll.bind(canvas),
                            onComplete: function() {
                                obj.animate({ scaleX: orig.scaleX, scaleY: orig.scaleY }, {
                                    duration: duration / 3, easing: easingFn, onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj
                                });
                            }
                        });
                    }
                });
                break;
            case 'float':
                obj.animate('top', orig.top - 20, {
                    duration: duration / 2, easing: fabric.util.ease.easeInOutSine || easingFn,
                    onChange: canvas.renderAll.bind(canvas),
                    onComplete: function() {
                        obj.animate('top', orig.top, {
                            duration: duration / 2, easing: fabric.util.ease.easeInOutSine || easingFn,
                            onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj
                        });
                    }
                });
                break;
            case 'glow':
                obj.set({ shadow: new fabric.Shadow({ color: 'rgba(102,126,234,0.8)', blur: 0, offsetX: 0, offsetY: 0 }) });
                canvas.renderAll();
                var shadowObj = obj.shadow;
                fabric.util.animate({
                    startValue: 0, endValue: 30, duration: duration / 2, easing: easingFn,
                    onChange: function(v) { if (shadowObj) { shadowObj.blur = v; canvas.renderAll(); } },
                    onComplete: function() {
                        fabric.util.animate({
                            startValue: 30, endValue: 0, duration: duration / 2, easing: easingFn,
                            onChange: function(v) { if (shadowObj) { shadowObj.blur = v; canvas.renderAll(); } },
                            onComplete: function() { obj.set({ shadow: null }); restoreObj(); }
                        });
                    }
                });
                break;
            case 'spinCW':
                obj.animate('angle', orig.angle + 360, { duration: duration, onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj });
                break;
            case 'spinCCW':
                obj.animate('angle', orig.angle - 360, { duration: duration, onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj });
                break;
            case 'breathe':
                obj.animate({ scaleX: orig.scaleX * 1.08, scaleY: orig.scaleY * 1.08 }, {
                    duration: duration / 2, easing: fabric.util.ease.easeInOutSine || easingFn,
                    onChange: canvas.renderAll.bind(canvas),
                    onComplete: function() {
                        obj.animate({ scaleX: orig.scaleX, scaleY: orig.scaleY }, {
                            duration: duration / 2, easing: fabric.util.ease.easeInOutSine || easingFn,
                            onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj
                        });
                    }
                });
                break;
            case 'blink':
                obj.animate('opacity', 0, {
                    duration: duration / 2, onChange: canvas.renderAll.bind(canvas),
                    onComplete: function() {
                        obj.animate('opacity', orig.opacity, {
                            duration: duration / 2, onChange: canvas.renderAll.bind(canvas), onComplete: restoreObj
                        });
                    }
                });
                break;
            default:
                restoreObj();
        }
    }

    // Run with delay
    setTimeout(runAnim, delay);
};

// ═══════════════════════════════════════════════════════════════
//  MEDIA LIBRARY — Image, Icon, PNG Search
// ═══════════════════════════════════════════════════════════════

var mediaState = {
    currentTab: 'photos',
    query: '',
    page: 1,
    loading: false,
    results: [],
    total: 0,
};

window.switchMediaTab = function(tab) {
    mediaState.currentTab = tab;
    mediaState.page = 1;
    mediaState.results = [];

    // Update active tab
    document.querySelectorAll('.media-lib-tab').forEach(function(t) { t.classList.remove('active'); });
    var tabId = { photos: 'tabPhotos', illustrations: 'tabIllust', icons: 'tabIcons', stickers: 'tabStickers' };
    var el = document.getElementById(tabId[tab]);
    if (el) el.classList.add('active');

    // Update search placeholder
    var input = document.getElementById('mediaSearchInput');
    var placeholders = {
        photos: 'Buscar fotos...',
        illustrations: 'Buscar ilustrações...',
        icons: 'Buscar ícones...',
        stickers: 'Buscar PNGs transparentes...',
    };
    input.placeholder = placeholders[tab] || 'Buscar...';

    // Show/hide categories bar
    var catBar = document.getElementById('mediaCategoriesBar');
    catBar.style.display = (tab === 'photos' || tab === 'illustrations' || tab === 'stickers') ? 'flex' : 'none';

    // Clear results
    showMediaStatus(getTabEmptyMsg(tab));
};

function getTabEmptyMsg(tab) {
    var msgs = {
        photos: '<i class="fas fa-camera"></i>Busque fotos gratuitas de alta qualidade',
        illustrations: '<i class="fas fa-paint-brush"></i>Busque ilustrações e vetores gratuitos',
        icons: '<i class="fas fa-icons"></i>Busque entre +100.000 ícones gratuitos',
        stickers: '<i class="fas fa-shapes"></i>Busque PNGs e vetores transparentes',
    };
    return msgs[tab] || '<i class="fas fa-image"></i>Buscar mídia gratuita';
}

function showMediaStatus(html) {
    document.getElementById('mediaResultsContainer').innerHTML = '<div class="media-status">' + html + '</div>';
}

window.searchMedia = function() {
    var query = document.getElementById('mediaSearchInput').value.trim();
    if (!query) return;
    mediaState.query = query;
    mediaState.page = 1;
    mediaState.results = [];
    executeMediaSearch();
};

window.searchMediaCategory = function(cat) {
    document.getElementById('mediaSearchInput').value = cat;
    mediaState.query = cat;
    mediaState.page = 1;
    mediaState.results = [];
    // Highlight active category
    document.querySelectorAll('.media-cat-btn').forEach(function(b) { b.classList.remove('active'); });
    event.target.classList.add('active');
    executeMediaSearch();
};

function executeMediaSearch() {
    if (mediaState.loading) return;
    mediaState.loading = true;

    var tab = mediaState.currentTab;
    var q = mediaState.query;
    var page = mediaState.page;

    showMediaStatus('<i class="fas fa-spinner fa-spin"></i>Buscando...');

    var url, isIconSearch = false;

    if (tab === 'icons') {
        url = '{% url "design_search_icons" %}?q=' + encodeURIComponent(q) + '&limit=60';
        isIconSearch = true;
    } else if (tab === 'stickers') {
        url = '{% url "design_search_stickers" %}?q=' + encodeURIComponent(q) + '&page=' + page + '&per_page=40';
    } else {
        var imageType = (tab === 'illustrations') ? 'illustration' : 'photo';
        url = '{% url "design_search_images" %}?q=' + encodeURIComponent(q) + '&page=' + page + '&per_page=40&image_type=' + imageType;
    }

    fetch(url, { headers: { 'X-CSRFToken': CSRF } })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        mediaState.loading = false;
        if (isIconSearch) {
            renderIconResults(data);
        } else {
            if (data.success && data.results) {
                if (page === 1) {
                    mediaState.results = data.results;
                } else {
                    mediaState.results = mediaState.results.concat(data.results);
                }
                mediaState.total = data.total || 0;
                renderImageResults();
            } else {
                showMediaStatus('<i class="fas fa-exclamation-circle"></i>' + (data.message || 'Nenhum resultado'));
            }
        }
    })
    .catch(function(err) {
        mediaState.loading = false;
        showMediaStatus('<i class="fas fa-exclamation-triangle"></i>Erro: ' + err.message);
    });
}

function renderImageResults() {
    var container = document.getElementById('mediaResultsContainer');
    if (mediaState.results.length === 0) {
        showMediaStatus('<i class="fas fa-search"></i>Nenhum resultado encontrado');
        return;
    }

    var html = '<div class="media-results-grid">';
    mediaState.results.forEach(function(item, idx) {
        html += '<div class="media-result-item" onclick="addMediaImageToCanvas(' + idx + ')" title="' + (item.tags || '').replace(/"/g, '&quot;') + '">';
        html += '<img src="' + item.thumbnail + '" alt="" loading="lazy">';
        html += '<div class="media-item-overlay">';
        html += '<span>' + (item.user || 'Pixabay') + '</span>';
        html += '</div></div>';
    });

    // Load more button
    if (mediaState.results.length < mediaState.total) {
        html += '<div class="media-load-more"><button onclick="loadMoreMedia()"><i class="fas fa-plus me-1"></i>Carregar mais</button></div>';
    }
    html += '</div>';

    // Attribution
    html += '<div style="text-align:center; font-size:9px; color:var(--panel-text-muted); margin-top:4px; padding:0 4px;">';
    html += '<i class="fas fa-info-circle me-1"></i>Imagens gratuitas via Pixabay';
    html += '</div>';

    container.innerHTML = html;
}

function renderIconResults(data) {
    var container = document.getElementById('mediaResultsContainer');
    if (!data.success || !data.icons || data.icons.length === 0) {
        if (data.collections && data.collections.length > 0) {
            // Show collections when no search query
            var html = '<div style="padding:4px;">';
            html += '<div style="font-size:10px; color:var(--panel-text-muted); margin-bottom:6px;">Coleções populares:</div>';
            data.collections.forEach(function(col) {
                html += '<button class="media-cat-btn" style="margin-bottom:3px;" onclick="searchIconCollection(\'' + col.prefix + '\')">';
                html += col.name + ' <span style="opacity:0.6;">(' + col.total + ')</span></button> ';
            });
            html += '</div>';
            container.innerHTML = html;
        } else {
            showMediaStatus('<i class="fas fa-search"></i>Nenhum ícone encontrado');
        }
        return;
    }

    var html = '<div class="icon-results-grid">';
    data.icons.forEach(function(icon) {
        html += '<div class="icon-result-item" onclick="addIconToCanvas(\'' + icon.fullName + '\')" title="' + icon.fullName + '">';
        html += '<img src="' + icon.previewUrl + '" alt="' + icon.name + '" loading="lazy">';
        html += '<span>' + icon.name + '</span>';
        html += '</div>';
    });
    html += '</div>';
    html += '<div style="text-align:center; font-size:9px; color:var(--panel-text-muted); margin-top:4px;">';
    html += '<i class="fas fa-info-circle me-1"></i>' + data.total + ' ícones encontrados via Iconify';
    html += '</div>';
    container.innerHTML = html;
}

window.searchIconCollection = function(prefix) {
    document.getElementById('mediaSearchInput').value = prefix;
    mediaState.query = prefix;
    mediaState.page = 1;
    mediaState.results = [];
    mediaState.currentTab = 'icons';
    executeMediaSearch();
};

window.loadMoreMedia = function() {
    mediaState.page++;
    executeMediaSearch();
};

// ── Add Image from Media Library to Canvas ──
window.addMediaImageToCanvas = function(idx) {
    var item = mediaState.results[idx];
    if (!item) return;

    showToast('Adicionando imagem...');

    // Use the full resolution URL
    var imgUrl = item.fullUrl || item.preview;

    fabric.Image.fromURL(imgUrl, function(img) {
        if (!img || !img.width) {
            showToast('Erro ao carregar imagem', true);
            return;
        }
        var maxW = CANVAS_W * 0.5;
        var maxH = CANVAS_H * 0.5;
        var scale = Math.min(maxW / img.width, maxH / img.height, 1);
        img.set({
            left: CANVAS_W / 2 - (img.width * scale) / 2,
            top: CANVAS_H / 2 - (img.height * scale) / 2,
            scaleX: scale, scaleY: scale,
        });
        canvas.add(img);
        canvas.setActiveObject(img);
        canvas.renderAll();
        showToast('Imagem adicionada!');
    }, { crossOrigin: 'anonymous' });
};

// ── Add Icon (SVG) to Canvas ──
window.addIconToCanvas = function(iconName) {
    showToast('Carregando ícone...');

    var url = '{% url "design_get_icon_svg" %}?icon=' + encodeURIComponent(iconName) + '&color=%23333333&size=256';

    fetch(url, { headers: { 'X-CSRFToken': CSRF } })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success && data.svg) {
            fabric.loadSVGFromString(data.svg, function(objects, options) {
                var svg = fabric.util.groupSVGElements(objects, options);
                // Scale to reasonable size on canvas
                var targetSize = Math.min(CANVAS_W, CANVAS_H) * 0.15;
                var scale = targetSize / Math.max(svg.width || 100, svg.height || 100);
                svg.set({
                    left: CANVAS_W / 2 - (svg.width * scale) / 2,
                    top: CANVAS_H / 2 - (svg.height * scale) / 2,
                    scaleX: scale, scaleY: scale,
                });
                canvas.add(svg);
                canvas.setActiveObject(svg);
                canvas.renderAll();
                showToast('Ícone adicionado!');
            });
        } else {
            showToast(data.message || 'Erro ao carregar ícone', true);
        }
    })
    .catch(function(err) {
        showToast('Erro: ' + err.message, true);
    });
};

// ═══════════════════════════════════════════════════════════════
//  AUDIO MANAGEMENT (per page)
// ═══════════════════════════════════════════════════════════════

window.handleAudioUpload = function(e) {
    var file = e.target.files[0];
    if (!file) return;
    var formData = new FormData();
    formData.append('audio', file);

    fetch('{% url "design_audio_upload" %}', {
        method: 'POST',
        headers: { 'X-CSRFToken': CSRF },
        body: formData
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            pages[currentPageIdx].audioUrl = data.audioUrl;
            syncPageSettingsUI();
            showToast('Áudio adicionado!');
            scheduleAutoSave();
        } else {
            showToast(data.message || 'Erro ao fazer upload', true);
        }
    })
    .catch(function(err) { showToast('Erro: ' + err.message, true); });
    e.target.value = '';
};

window.removePageAudio = function() {
    pages[currentPageIdx].audioUrl = '';
    syncPageSettingsUI();
    scheduleAutoSave();
};

// ═══════════════════════════════════════════════════════════════
//  PPTX IMPORT
// ═══════════════════════════════════════════════════════════════

window.handlePPTXImport = function(e) {
    var file = e.target.files[0];
    if (!file) return;
    showToast('Importando PPTX...');

    var formData = new FormData();
    formData.append('pptx', file);

    fetch('{% url "design_import_pptx" %}', {
        method: 'POST',
        headers: { 'X-CSRFToken': CSRF },
        body: formData
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            // Update canvas dimensions from PPTX
            CANVAS_W = data.canvasWidth || 1920;
            CANVAS_H = data.canvasHeight || 1080;
            document.getElementById('canvasWidth').value = CANVAS_W;
            document.getElementById('canvasHeight').value = CANVAS_H;

            // Convert imported pages to our format
            var importedPages = (data.pages || []).map(function(p, i) {
                return {
                    id: 'page_' + Date.now() + '_' + i,
                    name: p.name || ('Slide ' + (i + 1)),
                    duration: 5,
                    transition: 'fade',
                    transitionDuration: 0.5,
                    audioUrl: '',
                    fabricJson: p.fabricJson || null,
                    animations: [],
                    _thumbnail: null
                };
            });

            if (importedPages.length > 0) {
                // Save current page state
                saveCurrentPageState();
                // Replace all pages with imported ones
                pages = importedPages;
                currentPageIdx = 0;
                undoStack = []; redoStack = [];
                loadPageIntoCanvas(0, function() {
                    applyZoomToFabric(currentZoom);
                    canvas.renderAll();
                    updateLayers();
                    saveUndoState();
                    zoomFit();
                    renderPageStrip();
                    syncPageSettingsUI();
                });
                showToast('PPTX importado: ' + data.totalSlides + ' slide(s)!');
                scheduleAutoSave();
            } else {
                showToast('Nenhum slide encontrado no PPTX', true);
            }
        } else {
            showToast(data.message || 'Erro ao importar PPTX', true);
        }
    })
    .catch(function(err) { showToast('Erro: ' + err.message, true); });
    e.target.value = '';
};

// ═══════════════════════════════════════════════════════════════
//  MEDIA LIBRARY — Free Image/Icon Search & Add to Canvas
// ═══════════════════════════════════════════════════════════════

var currentMediaTab = 'photos';
var currentMediaPage = 1;
var currentMediaQuery = '';
var isMediaLoading = false;

window.switchMediaTab = function(tab) {
    currentMediaTab = tab;
    currentMediaPage = 1;
    currentMediaQuery = '';
    
    // Update active tab UI
    document.querySelectorAll('.media-lib-tab').forEach(function(el) {
        el.classList.remove('active');
    });
    var tabId = {
        'photos': 'tabPhotos',
        'illustrations': 'tabIllust',
        'icons': 'tabIcons',
        'stickers': 'tabStickers'
    }[tab];
    if (tabId) document.getElementById(tabId).classList.add('active');
    
    // Update placeholder
    var input = document.getElementById('mediaSearchInput');
    var placeholders = {
        'photos': 'Buscar fotos...',
        'illustrations': 'Buscar ilustrações...',
        'icons': 'Buscar ícones...',
        'stickers': 'Buscar PNGs transparentes...'
    };
    input.placeholder = placeholders[tab] || 'Buscar...';
    
    // Show/hide categories bar (only for photos/illustrations)
    var catBar = document.getElementById('mediaCategoriesBar');
    catBar.style.display = (tab === 'photos' || tab === 'illustrations') ? 'flex' : 'none';
    
    // Clear results
    document.getElementById('mediaResultsContainer').innerHTML = '<div class="media-status" id="mediaStatusMsg"><i class="fas fa-search"></i>Digite algo e busque</div>';
};

window.searchMedia = function() {
    var query = document.getElementById('mediaSearchInput').value.trim();
    if (!query) {
        showToast('Digite algo para buscar', true);
        return;
    }
    currentMediaQuery = query;
    currentMediaPage = 1;
    performMediaSearch(false);
};

window.searchMediaCategory = function(category) {
    document.getElementById('mediaSearchInput').value = category;
    currentMediaQuery = category;
    currentMediaPage = 1;
    performMediaSearch(false);
};

function performMediaSearch(append) {
    if (isMediaLoading) return;
    isMediaLoading = true;
    
    var container = document.getElementById('mediaResultsContainer');
    if (!append) {
        container.innerHTML = '<div class="media-status"><i class="fas fa-spinner fa-spin"></i>Buscando...</div>';
    }
    
    var url, params;
    
    if (currentMediaTab === 'icons') {
        // Iconify search
        url = '{% url "design_search_icons" %}';
        params = new URLSearchParams({
            q: currentMediaQuery,
            limit: 60
        });
    } else if (currentMediaTab === 'stickers') {
        // PNG/stickers
        url = '{% url "design_search_stickers" %}';
        params = new URLSearchParams({
            q: currentMediaQuery,
            page: currentMediaPage,
            per_page: 40
        });
    } else {
        // Photos or illustrations
        url = '{% url "design_search_images" %}';
        var imageType = currentMediaTab === 'illustrations' ? 'illustration' : 'photo';
        params = new URLSearchParams({
            q: currentMediaQuery,
            page: currentMediaPage,
            per_page: 40,
            image_type: imageType
        });
    }
    
    fetch(url + '?' + params.toString(), {
        method: 'GET',
        headers: { 'X-CSRFToken': CSRF }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        isMediaLoading = false;
        
        if (!data.success) {
            container.innerHTML = '<div class="media-status"><i class="fas fa-exclamation-triangle"></i>' + (data.message || 'Erro ao buscar') + '</div>';
            return;
        }
        
        if (currentMediaTab === 'icons') {
            renderIconResults(data.icons || [], append);
        } else {
            renderImageResults(data.results || [], data.total || 0, append);
        }
    })
    .catch(function(err) {
        isMediaLoading = false;
        container.innerHTML = '<div class="media-status"><i class="fas fa-exclamation-triangle"></i>Erro: ' + err.message + '</div>';
    });
}

function renderImageResults(results, total, append) {
    var container = document.getElementById('mediaResultsContainer');
    
    if (!append) {
        if (results.length === 0) {
            container.innerHTML = '<div class="media-status"><i class="fas fa-images"></i>Nenhum resultado encontrado</div>';
            return;
        }
        container.innerHTML = '<div class="media-results-grid" id="mediaResultsGrid"></div>';
    }
    
    var grid = document.getElementById('mediaResultsGrid');
    if (!grid) return;
    
    results.forEach(function(item) {
        var div = document.createElement('div');
        div.className = 'media-result-item';
        div.onclick = function() { addImageToCanvas(item.preview || item.fullUrl || item.thumbnail); };
        
        var img = document.createElement('img');
        img.src = item.thumbnail;
        img.alt = item.tags || '';
        img.loading = 'lazy';
        
        var overlay = document.createElement('div');
        overlay.className = 'media-item-overlay';
        overlay.textContent = item.user || item.source || '';
        
        div.appendChild(img);
        div.appendChild(overlay);
        grid.appendChild(div);
    });
    
    // Load more button (not for icons)
    if (total > results.length && results.length >= 20) {
        var loadMoreDiv = document.createElement('div');
        loadMoreDiv.className = 'media-load-more';
        loadMoreDiv.innerHTML = '<button onclick="loadMoreMedia()"><i class="fas fa-plus me-1"></i>Carregar mais</button>';
        grid.appendChild(loadMoreDiv);
    }
}

function renderIconResults(icons, append) {
    var container = document.getElementById('mediaResultsContainer');
    
    if (!append) {
        if (icons.length === 0) {
            container.innerHTML = '<div class="media-status"><i class="fas fa-icons"></i>Nenhum ícone encontrado</div>';
            return;
        }
        container.innerHTML = '<div class="icon-results-grid" id="iconResultsGrid"></div>';
    }
    
    var grid = document.getElementById('iconResultsGrid');
    if (!grid) return;
    
    icons.forEach(function(icon) {
        var div = document.createElement('div');
        div.className = 'icon-result-item';
        div.onclick = function() { addIconToCanvas(icon.fullName, icon.svgUrl); };
        
        var img = document.createElement('img');
        img.src = icon.previewUrl;
        img.alt = icon.name;
        img.loading = 'lazy';
        
        var span = document.createElement('span');
        span.textContent = icon.name;
        
        div.appendChild(img);
        div.appendChild(span);
        grid.appendChild(div);
    });
}

window.loadMoreMedia = function() {
    currentMediaPage++;
    performMediaSearch(true);
};

function addImageToCanvas(imageUrl) {
    if (!imageUrl) return;
    showToast('Adicionando imagem...');
    
    fabric.Image.fromURL(imageUrl, function(img) {
        if (!img || !img.width || !img.height) {
            showToast('Erro ao carregar imagem', true);
            return;
        }
        
        // Scale to fit 50% of canvas
        var maxW = CANVAS_W * 0.5;
        var maxH = CANVAS_H * 0.5;
        var scale = Math.min(maxW / img.width, maxH / img.height, 1);
        
        img.set({
            left: CANVAS_W / 2 - (img.width * scale) / 2,
            top: CANVAS_H / 2 - (img.height * scale) / 2,
            scaleX: scale,
            scaleY: scale
        });
        
        canvas.add(img);
        canvas.setActiveObject(img);
        canvas.renderAll();
        showToast('Imagem adicionada!');
    }, { crossOrigin: 'anonymous' });
}

function addIconToCanvas(iconFullName, svgUrl) {
    if (!iconFullName) return;
    showToast('Adicionando ícone...');
    
    // Fetch SVG via our proxy
    var url = '{% url "design_get_icon_svg" %}?' + new URLSearchParams({
        icon: iconFullName,
        color: '#333333',
        size: 256
    }).toString();
    
    fetch(url, {
        method: 'GET',
        headers: { 'X-CSRFToken': CSRF }
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (!data.success || !data.svg) {
            showToast('Erro ao carregar ícone', true);
            return;
        }
        
        // Create blob URL from SVG string
        var blob = new Blob([data.svg], { type: 'image/svg+xml' });
        var url = URL.createObjectURL(blob);
        
        fabric.loadSVGFromURL(url, function(objects, options) {
            var obj = fabric.util.groupSVGElements(objects, options);
            
            // Scale to ~200px
            var targetSize = 200;
            var scale = targetSize / Math.max(obj.width, obj.height);
            
            obj.set({
                left: CANVAS_W / 2 - (obj.width * scale) / 2,
                top: CANVAS_H / 2 - (obj.height * scale) / 2,
                scaleX: scale,
                scaleY: scale
            });
            
            canvas.add(obj);
            canvas.setActiveObject(obj);
            canvas.renderAll();
            showToast('Ícone adicionado!');
            
            URL.revokeObjectURL(url);
        });
    })
    .catch(function(err) {
        showToast('Erro: ' + err.message, true);
    });
}

// ── INIT ON LOAD ──
document.addEventListener('DOMContentLoaded', init);

})();
</script>
{% endblock %}
