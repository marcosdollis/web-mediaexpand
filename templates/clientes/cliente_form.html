{% extends "base/base.html" %}
{% load static %}

{% block title %}{% if cliente %}Editar{% else %}Novo{% endif %} Cliente - MediaExpand{% endblock %}

{% block extra_head %}
<style>
    .municipio-checkbox {
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .municipio-checkbox:hover {
        background-color: #f8f9fa;
        border-color: #0d6efd;
    }
    .municipio-checkbox input[type="checkbox"]:checked ~ label {
        font-weight: bold;
        color: #0d6efd;
    }
    .municipio-group {
        margin-bottom: 20px;
    }
    .municipio-group-header {
        background-color: #e9ecef;
        padding: 8px 12px;
        border-radius: 5px;
        font-weight: bold;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'cliente_list' %}">Clientes</a></li>
                <li class="breadcrumb-item active">{% if cliente %}Editar{% else %}Novo{% endif %}</li>
            </ol>
        </nav>
        <h1 class="h3">
            <i class="bi bi-person-badge{% if not cliente %}-fill{% endif %} me-2"></i>
            {% if cliente %}Editar Cliente: {{ cliente.empresa }}{% else %}Novo Cliente{% endif %}
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    
                    <h5 class="mb-3">
                        <i class="bi bi-building me-2"></i>Dados da Empresa
                    </h5>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Nome da Empresa <span class="text-danger">*</span></label>
                            <input type="text" name="empresa" class="form-control" required 
                                   value="{{ cliente.empresa }}"
                                   placeholder="Ex: Supermercado Silva, Restaurante Bom Sabor...">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Segmento <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <select name="segmento" id="segmentoSelect" class="form-select" required>
                                    <option value="">Selecione o segmento</option>
                                    {% for seg in segmentos %}
                                    <option value="{{ seg.id }}" {% if cliente.segmento_id == seg.id %}selected{% endif %}>
                                        {{ seg.nome }}
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if user.is_owner or user.is_franchisee %}
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#novoSegmentoModal">
                                    <i class="bi bi-plus-lg"></i>
                                </button>
                                {% endif %}
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                Apenas uma marca por segmento por cidade
                            </small>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Observações</label>
                            <textarea name="observacoes" class="form-control" rows="3" 
                                      placeholder="Informações adicionais sobre o cliente...">{{ cliente.observacoes }}</textarea>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Contrato</label>
                            {% if cliente.contrato %}
                            <div class="alert alert-success d-flex align-items-center justify-content-between mb-2">
                                <div>
                                    <i class="bi bi-file-earmark-pdf me-2"></i>
                                    <strong>Contrato atual:</strong> 
                                    <a href="{{ cliente.contrato.url }}" target="_blank" class="alert-link">
                                        {{ cliente.contrato.name|slice:"10:" }}
                                    </a>
                                    <small class="text-muted">({{ cliente.contrato.size|filesizeformat }})</small>
                                </div>
                                <div class="form-check form-switch">
                                    <input type="checkbox" name="remover_contrato" class="form-check-input" id="remover_contrato">
                                    <label class="form-check-label" for="remover_contrato">Remover</label>
                                </div>
                            </div>
                            {% endif %}
                            <input type="file" name="contrato" class="form-control" accept=".pdf,.doc,.docx">
                            <small class="text-muted">
                                Formatos aceitos: PDF, DOC, DOCX. 
                                {% if not cliente %}Upload opcional.{% else %}Deixe em branco para manter o atual.{% endif %}
                            </small>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">
                        <i class="bi bi-person me-2"></i>Dados de Acesso
                    </h5>
                    
                    {% if cliente %}
                    <!-- Modo Edição -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" value="{{ cliente.user.username }}" disabled>
                            <small class="text-muted">O username não pode ser alterado</small>
                        </div>
                    </div>
                    {% else %}
                    <!-- Modo Criação -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Username <span class="text-danger">*</span></label>
                            <input type="text" name="username" class="form-control" required 
                                   placeholder="Digite o username único para login">
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Nome</label>
                            <input type="text" name="first_name" class="form-control" 
                                   value="{{ cliente.user.first_name }}" placeholder="Primeiro nome">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Sobrenome</label>
                            <input type="text" name="last_name" class="form-control" 
                                   value="{{ cliente.user.last_name }}" placeholder="Sobrenome">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-control" 
                                   value="{{ cliente.user.email }}" placeholder="email@exemplo.com">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">
                                {% if cliente %}Nova Senha (opcional){% else %}Senha{% endif %}
                                {% if not cliente %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            <input type="password" name="password" class="form-control" 
                                   {% if not cliente %}required{% endif %}
                                   placeholder="{% if cliente %}Deixe em branco para manter{% else %}Digite a senha{% endif %}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">
                                Confirmar Senha
                                {% if not cliente %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            <input type="password" name="password_confirm" class="form-control" 
                                   {% if not cliente %}required{% endif %}
                                   placeholder="Digite novamente">
                        </div>
                    </div>
                    
                    {% if cliente %}
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input type="checkbox" name="is_active" class="form-check-input" 
                                       id="is_active" {% if cliente.ativo %}checked{% endif %}>
                                <label class="form-check-label" for="is_active">
                                    Cliente ativo
                                </label>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <hr class="my-4">
                    
                    <h5 class="mb-3">
                        <i class="bi bi-geo-alt me-2"></i>Municípios de Atuação <span class="text-danger">*</span>
                    </h5>
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Importante:</strong> Selecione os municípios onde este cliente poderá exibir seus vídeos.
                    </div>
                    
                    {% if user.is_owner %}
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Franqueado Responsável</label>
                            <select name="franqueado" class="form-select" {% if not cliente %}required{% endif %}>
                                {% if not cliente %}<option value="">Selecione o franqueado...</option>{% endif %}
                                {% for f in franqueados %}
                                <option value="{{ f.id }}" {% if cliente.franqueado_id == f.id %}selected{% endif %}>
                                    {{ f.get_full_name|default:f.username }} (@{{ f.username }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            {% if municipios %}
                            <div id="municipios-selection">
                                {% regroup municipios by estado as municipios_by_estado %}
                                {% for estado_group in municipios_by_estado %}
                                <div class="municipio-group">
                                    <div class="municipio-group-header">
                                        <i class="bi bi-geo-alt-fill me-2"></i>{{ estado_group.grouper }}
                                        <button type="button" class="btn btn-sm btn-outline-primary float-end select-all-estado" 
                                                data-estado="{{ estado_group.grouper }}">
                                            Selecionar Todos
                                        </button>
                                    </div>
                                    <div class="row">
                                        {% for municipio in estado_group.list %}
                                        <div class="col-md-6">
                                            <div class="municipio-checkbox">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" 
                                                           name="municipios" value="{{ municipio.id }}" 
                                                           id="mun_{{ municipio.id }}"
                                                           data-estado="{{ municipio.estado }}"
                                                           {% if cliente and municipio in cliente.municipios.all %}checked{% endif %}>
                                                    <label class="form-check-label w-100" for="mun_{{ municipio.id }}">
                                                        {{ municipio.nome }}
                                                        {% if municipio.franqueado %}
                                                        <small class="text-muted">
                                                            ({{ municipio.franqueado.get_full_name|default:municipio.franqueado.username }})
                                                        </small>
                                                        {% endif %}
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <div class="mt-3">
                                <button type="button" class="btn btn-sm btn-outline-success" id="select-all">
                                    <i class="bi bi-check-all me-1"></i>Selecionar Todos
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="deselect-all">
                                    <i class="bi bi-x-circle me-1"></i>Desmarcar Todos
                                </button>
                                <span class="ms-3 text-muted">
                                    <strong id="selected-count">0</strong> município(s) selecionado(s)
                                </span>
                            </div>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Atenção:</strong> Não há municípios disponíveis.
                                {% if user.is_owner %}
                                <a href="{% url 'municipio_create' %}" class="alert-link">Criar um município agora</a>
                                {% else %}
                                Entre em contato com o administrador.
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'cliente_list' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-1"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary" {% if not municipios %}disabled{% endif %}>
                            <i class="bi bi-check-circle me-1"></i>
                            {% if cliente %}Atualizar{% else %}Criar{% endif %} Cliente
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Contar municípios selecionados
    function updateCount() {
        const count = document.querySelectorAll('input[name="municipios"]:checked').length;
        document.getElementById('selected-count').textContent = count;
    }
    
    // Selecionar todos
    document.getElementById('select-all')?.addEventListener('click', function() {
        document.querySelectorAll('input[name="municipios"]').forEach(cb => cb.checked = true);
        updateCount();
    });
    
    // Desmarcar todos
    document.getElementById('deselect-all')?.addEventListener('click', function() {
        document.querySelectorAll('input[name="municipios"]').forEach(cb => cb.checked = false);
        updateCount();
    });
    
    // Selecionar todos de um estado
    document.querySelectorAll('.select-all-estado').forEach(btn => {
        btn.addEventListener('click', function() {
            const estado = this.dataset.estado;
            const allChecked = Array.from(document.querySelectorAll(`input[name="municipios"][data-estado="${estado}"]`))
                .every(cb => cb.checked);
            
            document.querySelectorAll(`input[name="municipios"][data-estado="${estado}"]`).forEach(cb => {
                cb.checked = !allChecked;
            });
            
            this.textContent = allChecked ? 'Selecionar Todos' : 'Desmarcar Todos';
            updateCount();
        });
    });
    
    // Atualizar contador ao clicar
    document.querySelectorAll('input[name="municipios"]').forEach(cb => {
        cb.addEventListener('change', updateCount);
    });
    
    // Inicializar contador
    updateCount();
});
</script>

<!-- Modal Novo Segmento -->
<div class="modal fade" id="novoSegmentoModal" tabindex="-1" aria-labelledby="novoSegmentoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="novoSegmentoModalLabel">
                    <i class="bi bi-tag me-2"></i>
                    Novo Segmento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="formNovoSegmento">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="nomeSegmento" class="form-label">Nome do Segmento <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nomeSegmento" name="nome" required
                               placeholder="Ex: Alimentação, Saúde, Educação...">
                        <div class="invalid-feedback" id="nomeSegmentoError"></div>
                    </div>
                    <div class="mb-3">
                        <label for="descricaoSegmento" class="form-label">Descrição</label>
                        <textarea class="form-control" id="descricaoSegmento" name="descricao" rows="3"
                                  placeholder="Descrição opcional do segmento..."></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="ativoSegmento" name="ativo" checked>
                            <label class="form-check-label" for="ativoSegmento">
                                Segmento Ativo
                            </label>
                        </div>
                    </div>
                    <div class="alert alert-danger d-none" id="segmentoModalError"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnSalvarSegmento">
                    <i class="bi bi-check-lg me-1"></i>
                    Salvar Segmento
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Script para salvar segmento via AJAX
document.getElementById('btnSalvarSegmento').addEventListener('click', function() {
    console.log('Botão clicado - iniciando salvamento de segmento');
    
    const form = document.getElementById('formNovoSegmento');
    const formData = new FormData(form);
    const btn = this;
    const btnOriginal = btn.innerHTML;
    
    // Log dos dados do formulário
    console.log('Dados do formulário:');
    for (let [key, value] of formData.entries()) {
        console.log(`${key}: ${value}`);
    }
    
    // Resetar erros (verificar se elementos existem)
    const nomeInput = document.getElementById('nomeSegmento');
    const nomeError = document.getElementById('nomeSegmentoError');
    const modalError = document.getElementById('segmentoModalError');
    
    if (nomeInput) nomeInput.classList.remove('is-invalid');
    if (modalError) modalError.classList.add('d-none');
    
    // Mostrar loading
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Salvando...';
    
    console.log('Enviando requisição para:', '{% url "segmento_create" %}');
    
    fetch('{% url "segmento_create" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('Resposta recebida. Status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Dados da resposta:', data);
        
        if (data.success) {
            console.log('Segmento criado com sucesso:', data.segmento);
            
            // Adicionar novo segmento ao select
            const select = document.getElementById('segmentoSelect');
            const option = new Option(data.segmento.nome, data.segmento.id, true, true);
            select.add(option);
            console.log('Segmento adicionado ao select');
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('novoSegmentoModal'));
            modal.hide();
            console.log('Modal fechado');
            
            // Limpar formulário
            form.reset();
            
            // Mostrar mensagem de sucesso
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                <i class="bi bi-check-circle me-2"></i>
                <strong>Sucesso!</strong> Segmento "${data.segmento.nome}" criado com sucesso!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.card-body form').prepend(alert);
            
            // Remover alerta após 5 segundos
            setTimeout(() => alert.remove(), 5000);
        } else {
            console.log('Erro ao criar segmento:', data.errors);
            
            // Mostrar erros
            if (data.errors.nome && nomeInput && nomeError) {
                nomeInput.classList.add('is-invalid');
                nomeError.textContent = data.errors.nome[0];
            }
            if (data.errors.__all__ && modalError) {
                modalError.textContent = data.errors.__all__[0];
                modalError.classList.remove('d-none');
            }
        }
    })
    .catch(error => {
        console.error('Erro na requisição:', error);
        if (modalError) {
            modalError.textContent = 'Erro ao criar segmento. Tente novamente.';
            modalError.classList.remove('d-none');
        }
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = btnOriginal;
        console.log('Processo finalizado');
    });
});

// Limpar modal ao fechar
document.getElementById('novoSegmentoModal').addEventListener('hidden.bs.modal', function() {
    const form = document.getElementById('formNovoSegmento');
    const nomeInput = document.getElementById('nomeSegmento');
    const modalError = document.getElementById('segmentoModalError');
    
    form.reset();
    if (nomeInput) nomeInput.classList.remove('is-invalid');
    if (modalError) modalError.classList.add('d-none');
});
</script>
{% endblock %}
